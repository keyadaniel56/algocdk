<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <link rel="stylesheet" href="output.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bots Marketplace | AlgoCDK - AI Trading Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#fff0f0',
                            100: '#ffd6d6',
                            500: '#ff4500',
                            600: '#e63e00',
                            700: '#cc3700',
                        },
                        dark: {
                            900: '#000000',
                            800: '#1a1a1a',
                            700: '#333333',
                            600: '#4d4d4d',
                        },
                        success: {
                            500: '#10b981',
                            600: '#059669',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #ff4500;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #e63e00;
        }

        body {
            font-family: 'Inter', sans-serif;
        }

        .sidebar-item.active {
            background: rgba(255, 69, 0, 0.1);
            border-left: 3px solid #ff4500;
            color: #ff4500;
        }

        .card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 69, 0, 0.3);
        }

        .ai-analyzing {
            background: linear-gradient(90deg, #000000, #1a1a1a, #000000);
            background-size: 200% 100%;
            animation: shimmer 3s infinite;
            border-color: rgba(255, 69, 0, 0.2);
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        .bot-running {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 69, 0, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(255, 69, 0, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 69, 0, 0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        /* Profile dropdown styles */
        .profile-dropdown-item {
            transition: all 0.2s ease;
        }

        .profile-dropdown-item:hover {
            background: rgba(255, 69, 0, 0.1);
        }

        /* Marketplace specific styles */
        .category-filter.active {
            background: rgba(255, 69, 0, 0.1);
            border-color: rgba(255, 69, 0, 0.3);
            color: #ff4500;
        }
    </style>
</head>

<body class="bg-dark-900 text-white min-h-screen">
    <!-- Top Navigation Bar -->
    <nav class="bg-dark-800 border-b border-dark-700 py-3 px-6 flex justify-between items-center">
        <div class="flex items-center">
            <a href="#" class="text-xl font-bold text-white flex items-center">
                <div class="w-8 h-8 rounded-lg bg-primary-500 flex items-center justify-center mr-2">
                    <i class="fas fa-robot text-white text-sm"></i>
                </div>
                Algocdk
            </a>
        </div>

        <div class="flex items-center space-x-4">
            <div class="hidden md:flex items-center space-x-2 bg-dark-700 px-3 py-1 rounded-lg border border-dark-600">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                <span class="text-sm">Live</span>
            </div>

            <div class="relative">
                <button id="userMenuButton" class="flex items-center space-x-2 focus:outline-none">
                    <div id="userAvatar"
                        class="w-8 h-8 rounded-full bg-primary-500 flex items-center justify-center text-white font-medium">
                        <i class="fas fa-user"></i>
                    </div>
                    <span id="userName" class="hidden md:block">Loading...</span>
                    <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                </button>

                <!-- User Dropdown -->
                <div id="userDropdown"
                    class="absolute right-0 mt-2 w-56 bg-dark-800 rounded-lg shadow-xl border border-dark-700 hidden z-10">
                    <div class="p-4 border-b border-dark-700">
                        <div class="flex items-center space-x-3">
                            <div id="dropdownAvatar"
                                class="w-10 h-10 rounded-full bg-primary-500 flex items-center justify-center text-white font-medium">
                                <i class="fas fa-user"></i>
                            </div>
                            <div>
                                <h3 id="dropdownName" class="font-medium text-white">Loading...</h3>
                                <p id="dropdownEmail" class="text-xs text-gray-400 truncate max-w-[150px]">Loading...
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="py-2">
                        <a href="./profile"
                            class="profile-dropdown-item block px-4 py-2.5 text-sm text-gray-300 hover:text-white hover:bg-dark-700 transition-colors flex items-center">
                            <i class="fas fa-user-circle mr-3 text-gray-400"></i>
                            Profile
                        </a>
                        <a href="./settings"
                            class="profile-dropdown-item block px-4 py-2.5 text-sm text-gray-300 hover:text-white hover:bg-dark-700 transition-colors flex items-center">
                            <i class="fas fa-cog mr-3 text-gray-400"></i>
                            Settings
                        </a>
                        <a href="./billings"
                            class="profile-dropdown-item block px-4 py-2.5 text-sm text-gray-300 hover:text-white hover:bg-dark-700 transition-colors flex items-center">
                            <i class="fas fa-credit-card mr-3 text-gray-400"></i>
                            Billing
                        </a>
                        <div class="border-t border-dark-700 my-1"></div>
                        <a href="#" id="logoutButton"
                            class="profile-dropdown-item block px-4 py-2.5 text-sm text-red-500 hover:bg-dark-700 transition-colors flex items-center">
                            <i class="fas fa-sign-out-alt mr-3"></i>Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="flex">
        <!-- Sidebar Navigation -->
        <div class="hidden md:flex md:w-64 md:flex-col">
            <div class="flex flex-col flex-grow pt-5 overflow-y-auto bg-dark-800 border-r border-dark-700">
                <div class="flex-grow flex flex-col">
                    <nav class="flex-1 px-4 space-y-2 py-4">
                        <a href="./app"
                            class="sidebar-item flex items-center px-4 py-3 text-sm font-medium text-gray-400 rounded-lg hover:bg-dark-700 hover:text-white transition-colors group">
                            <i class="fas fa-tachometer-alt mr-3"></i>
                            Dashboard
                        </a>
                        <a href="./mybots"
                            class="sidebar-item flex items-center px-4 py-3 text-sm font-medium text-gray-400 rounded-lg hover:bg-dark-700 hover:text-white transition-colors group">
                            <i class="fas fa-robot mr-3"></i>
                            My Bots
                        </a>
                        <a href="./botstore"
                            class="sidebar-item active flex items-center px-4 py-3 text-sm font-medium rounded-lg group">
                            <i class="fas fa-store mr-3 text-primary-500"></i>
                            Bots Marketplace
                        </a>
                        <a href="#"
                            class="sidebar-item flex items-center px-4 py-3 text-sm font-medium text-gray-400 rounded-lg hover:bg-dark-700 hover:text-white transition-colors group">
                            <i class="fas fa-history mr-3"></i>
                            Trade History
                        </a>
                        <a href="./support"
                            class="sidebar-item flex items-center px-4 py-3 text-sm font-medium text-gray-400 rounded-lg hover:bg-dark-700 hover:text-white transition-colors group">
                            <i class="fas fa-question-circle mr-3"></i>
                            Support
                        </a>
                        <a href="./settings"
                            class="sidebar-item flex items-center px-4 py-3 text-sm font-medium text-gray-400 rounded-lg hover:bg-dark-700 hover:text-white transition-colors group">
                            <i class="fas fa-cog mr-3"></i>
                            Settings
                        </a>
                    </nav>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-x-hidden">
            <main class="p-6 fade-in">
                <!-- Welcome Section -->
                <div class="mb-8">
                    <h1 id="welcomeMessage" class="text-3xl font-bold text-white mb-2">Bots Marketplace</h1>
                    <p class="text-gray-400 max-w-3xl">Discover, customize, and deploy intelligent trading bots that
                        work 24/7 to maximize your profits.</p>
                </div>

                <!-- Marketplace Stats Banner -->
                <div class="ai-analyzing rounded-xl p-4 mb-8 border border-primary-500/20">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-primary-500/20 flex items-center justify-center mr-4">
                            <i class="fas fa-store text-primary-500"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-medium text-white">Browse Premium Trading Bots</h3>
                            <p class="text-sm text-gray-400">Explore our collection of AI-powered trading algorithms
                                with proven track records</p>
                        </div>
                        <div class="hidden md:flex items-center space-x-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-white" id="totalBotsCount">0</div>
                                <div class="text-xs text-gray-400">Total Bots</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-white" id="activeBotsCount">0</div>
                                <div class="text-xs text-gray-400">Active Now</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-white" id="newBotsCount">0</div>
                                <div class="text-xs text-gray-400">New This Week</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search and Filters Section -->
                <div class="mb-8">
                    <div
                        class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 space-y-4 md:space-y-0">
                        <div class="flex-1">
                            <!-- Search Bar -->
                            <div class="relative max-w-md">
                                <input type="text" id="searchInput" placeholder="Search trading bots..."
                                    class="w-full pl-10 pr-4 py-2 bg-dark-700 border border-dark-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-white">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            </div>
                        </div>

                        <div class="flex items-center space-x-3">
                            <!-- Sort Dropdown -->
                            <div class="relative">
                                <select id="sortSelect"
                                    class="bg-dark-800 border border-dark-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-white appearance-none pr-8">
                                    <option value="newest">Newest First</option>
                                    <option value="popular">Most Popular</option>
                                    <option value="rating">Highest Rated</option>
                                    <option value="performance">Best Performance</option>
                                    <option value="price-low">Price: Low to High</option>
                                    <option value="price-high">Price: High to Low</option>
                                </select>
                                <i
                                    class="fas fa-chevron-down absolute right-3 top-3 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Category Filters -->
                    <div class="flex flex-wrap gap-3 mb-6" id="categoryFilters">
                        <button
                            class="category-filter active bg-primary-500/20 text-primary-500 px-4 py-2 rounded-lg border border-primary-500/30 font-medium"
                            data-category="all">
                            All Bots
                        </button>
                        <button
                            class="category-filter bg-dark-700 text-gray-300 px-4 py-2 rounded-lg border border-dark-600 hover:bg-dark-600 transition-colors"
                            data-category="digit">
                            Digit Bots
                        </button>
                        <button
                            class="category-filter bg-dark-700 text-gray-300 px-4 py-2 rounded-lg border border-dark-600 hover:bg-dark-600 transition-colors"
                            data-category="risefall">
                            Rise/Fall Bots
                        </button>
                        <button
                            class="category-filter bg-dark-700 text-gray-300 px-4 py-2 rounded-lg border border-dark-600 hover:bg-dark-600 transition-colors"
                            data-category="evenodd">
                            Even/Odd Bots
                        </button>
                        <button
                            class="category-filter bg-dark-700 text-gray-300 px-4 py-2 rounded-lg border border-dark-600 hover:bg-dark-600 transition-colors"
                            data-category="community">
                            Community
                        </button>
                        <button
                            class="category-filter bg-dark-700 text-gray-300 px-4 py-2 rounded-lg border border-dark-600 hover:bg-dark-600 transition-colors"
                            data-category="premium">
                            Premium
                        </button>
                    </div>
                </div>

                <!-- Bots Grid Section -->
                <section>
                    <div id="loadingIndicator" class="flex justify-center items-center py-12">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-500"></div>
                        <span class="ml-3 text-gray-400">Loading trading bots...</span>
                    </div>

                    <div id="botsGrid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Bot cards will be populated here by JavaScript -->
                    </div>

                    <div id="noResults" class="hidden text-center py-12">
                        <i class="fas fa-robot text-5xl text-gray-600 mb-4"></i>
                        <h3 class="text-xl font-medium text-white mb-2">No bots found</h3>
                        <p class="text-gray-400">Try adjusting your search or filter criteria</p>
                    </div>
                </section>
            </main>

            <!-- Footer -->
            <footer class="bg-dark-800 border-t border-dark-700 py-6 px-6">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="mb-4 md:mb-0">
                        <p class="text-gray-400 text-sm">&copy; <span id="currentYear"></span> AlgoCDK. All rights
                            reserved.</p>
                    </div>
                    <div class="flex space-x-6">
                        <a href="#" class="text-gray-400 hover:text-white transition-colors text-sm">Terms</a>
                        <a href="#" class="text-gray-400 hover:text-white transition-colors text-sm">Privacy</a>
                        <a href="#" class="text-gray-400 hover:text-white transition-colors text-sm">Support</a>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <!-- Loading Spinner Template (Hidden by default) -->
    <div id="loadingSpinner" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-dark-800 rounded-xl p-6 flex flex-col items-center border border-dark-600">
            <div class="w-16 h-16 border-4 border-primary-500 border-t-transparent rounded-full animate-spin mb-4">
            </div>
            <p class="text-white">Processing your request...</p>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        // Set current year in footer
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        // Global state
        let botsData = [];
        let filteredBots = [];
        let currentCategory = 'all';
        let currentSort = 'newest';
        let currentSearch = '';

        // DOM Elements
        const userMenuButton = document.getElementById('userMenuButton');
        const userDropdown = document.getElementById('userDropdown');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const botsGrid = document.getElementById('botsGrid');
        const noResults = document.getElementById('noResults');
        const searchInput = document.getElementById('searchInput');
        const sortSelect = document.getElementById('sortSelect');
        const categoryFilters = document.querySelectorAll('.category-filter');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const totalBotsCount = document.getElementById('totalBotsCount');
        const activeBotsCount = document.getElementById('activeBotsCount');
        const newBotsCount = document.getElementById('newBotsCount');

        // User dropdown functionality
        userMenuButton.addEventListener('click', (e) => {
            e.stopPropagation();
            userDropdown.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (event) => {
            if (!userMenuButton.contains(event.target) && !userDropdown.contains(event.target)) {
                userDropdown.classList.add('hidden');
            }
        });

        // Logout functionality
        document.getElementById('logoutButton').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('token');
            localStorage.removeItem('userData');
            window.location.href = '/';
        });

        // Authentication check
        if (!localStorage.getItem('token')) {
            window.location.href = '/';
        }

        // Utility function for authenticated fetch requests
        async function authFetch(url, options = {}) {
            const token = localStorage.getItem('token');
            if (!token) {
                throw new Error('No authentication token found');
            }

            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                },
            };

            const response = await fetch(url, { ...defaultOptions, ...options });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || errorData.message || `Request failed: ${response.status}`);
            }

            return response.json();
        }

        // Function to get user initials for avatar
        function getUserInitials(name) {
            if (!name || name === 'Loading...' || name === 'User') return 'U';

            const nameParts = name.split(' ');
            if (nameParts.length === 1) {
                return nameParts[0].charAt(0).toUpperCase();
            }
            return (nameParts[0].charAt(0) + nameParts[nameParts.length - 1].charAt(0)).toUpperCase();
        }

        // Function to extract user name from various possible field names
        function extractUserName(userData) {
            const nameFields = [
                'name', 'fullName', 'username', 'userName', 'displayName', 'first_name', 'firstName', 'firstname'
            ];

            for (const field of nameFields) {
                if (userData[field] && typeof userData[field] === 'string') {
                    return userData[field];
                }
            }

            if (userData.email) {
                const email = userData.email.split('@')[0];
                return email.charAt(0).toUpperCase() + email.slice(1);
            }

            return 'User';
        }

        // Function to extract user email from various possible field names
        function extractUserEmail(userData) {
            const emailFields = ['email', 'emailAddress', 'userEmail'];

            for (const field of emailFields) {
                if (userData[field] && typeof userData[field] === 'string') {
                    return userData[field];
                }
            }

            return null;
        }

        // Function to update user profile in UI
        function updateUserProfile(userData) {
            const userName = extractUserName(userData);
            const userEmail = extractUserEmail(userData);

            // Update navigation bar
            const userNameElement = document.getElementById('userName');
            const userAvatarElement = document.getElementById('userAvatar');

            userNameElement.textContent = userName;
            userAvatarElement.textContent = getUserInitials(userName);

            // Update dropdown profile
            const dropdownName = document.getElementById('dropdownName');
            const dropdownEmail = document.getElementById('dropdownEmail');
            const dropdownAvatar = document.getElementById('dropdownAvatar');

            dropdownName.textContent = userName;
            dropdownEmail.textContent = userEmail || 'No email provided';
            dropdownAvatar.textContent = getUserInitials(userName);

            // Update welcome message
            const welcomeMessage = document.getElementById('welcomeMessage');
            const timeOfDay = getTimeOfDay();
            const greeting = getGreeting(timeOfDay);
            const firstName = userName.split(' ')[0];
            welcomeMessage.textContent = `${greeting}, ${firstName}!`;
        }

        // Helper function to get time of day
        function getTimeOfDay() {
            const hour = new Date().getHours();
            if (hour < 12) return 'morning';
            if (hour < 18) return 'afternoon';
            return 'evening';
        }

        // Helper function to get greeting
        function getGreeting(timeOfDay) {
            switch (timeOfDay) {
                case 'morning': return 'Good morning';
                case 'afternoon': return 'Good afternoon';
                case 'evening': return 'Good evening';
                default: return 'Welcome';
            }
        }

        // Load user profile
        async function loadUserProfile() {
            try {
                updateUserProfile({ name: 'Loading...', email: 'Loading...' });

                const response = await authFetch('/api/user/profile');
                const userData = response.data || response.user || response;

                if (!userData || typeof userData !== 'object') {
                    throw new Error('Invalid user data format received');
                }

                localStorage.setItem('userData', JSON.stringify(userData));
                updateUserProfile(userData);

                return userData;
            } catch (error) {
                console.error('Failed to load user profile:', error);
                updateUserProfile({ name: 'Trader', email: 'user@example.com' });

                const cachedUserData = localStorage.getItem('userData');
                if (cachedUserData) {
                    try {
                        const parsedData = JSON.parse(cachedUserData);
                        updateUserProfile(parsedData);
                    } catch (parseError) {
                        console.error('Failed to parse cached user data:', parseError);
                    }
                }

                return null;
            }
        }

        // Fetch bots from API
        async function fetchBots() {
            try {
                loadingIndicator.classList.remove('hidden');

                // Fetch from your API endpoint - matches the endpoint in your reference code
                const response = await authFetch('/api/marketplace');

                // Handle the exact same response structure as your reference code
                let botsData = response;
                let bots = botsData.bots || [];

                if (!Array.isArray(bots) && Array.isArray(response)) {
                    bots = response; // In case API returns array directly
                }

                console.log('API Response:', response);
                console.log('Bots found:', bots);

                // Update stats
                updateMarketplaceStats(bots);

                // Store data
                window.botsData = bots;

                // Apply initial filter and sort
                filteredBots = [...bots];
                applyFilters();

            } catch (error) {
                console.error('Failed to fetch bots:', error);

                // Use fallback dummy data that matches your reference structure
                window.botsData = getDummyBotsData();
                updateMarketplaceStats(window.botsData);
                filteredBots = [...window.botsData];
                applyFilters();

                showNotification('Failed to load bots from API. Using demo data.', 'warning');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        // Fallback dummy data that matches your reference structure exactly
        function getDummyBotsData() {
            return [
                {
                    id: 1,
                    name: "AI RiseFall Pro",
                    creator: { name: "AlgoCDK Team" },
                    category: "risefall",
                    rating: 4.8,
                    performance: "+12.4%",
                    users: 1247,
                    description: "Advanced AI that predicts rise/fall movements with high accuracy using machine learning.",
                    is_favorite: false,
                    isNew: true,
                    status: "active",
                    price: 299.99,
                    rent_price: 29.99,
                    image: "",
                    strategy: "AI Prediction",
                    created_at: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString()
                },
                {
                    id: 2,
                    name: "Volatility Hunter",
                    creator: { name: "MarketWizards" },
                    category: "digit",
                    rating: 4.6,
                    performance: "+15.2%",
                    users: 892,
                    description: "Capitalizes on market volatility with adaptive risk management and dynamic position sizing.",
                    is_favorite: true,
                    isNew: false,
                    status: "active",
                    price: 249.99,
                    rent_price: 24.99,
                    image: "",
                    strategy: "Volatility",
                    created_at: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString()
                },
                {
                    id: 3,
                    name: "Trend Follower",
                    creator: { name: "CryptoGuru" },
                    category: "risefall",
                    rating: 4.5,
                    performance: "+10.3%",
                    users: 1045,
                    description: "Identifies and rides market trends with precision entry points and trailing stop losses.",
                    is_favorite: false,
                    isNew: false,
                    status: "active",
                    price: 199.99,
                    rent_price: 19.99,
                    image: "",
                    strategy: "Trend Following",
                    created_at: new Date(Date.now() - 14 * 24 * 60 * 60 * 1000).toISOString()
                },
                {
                    id: 4,
                    name: "Momentum Trader",
                    creator: { name: "QuantPro" },
                    category: "evenodd",
                    rating: 4.7,
                    performance: "+13.6%",
                    users: 756,
                    description: "Captures short-term momentum with rapid execution and optimized risk-reward ratios.",
                    is_favorite: false,
                    isNew: true,
                    status: "active",
                    price: 349.99,
                    rent_price: 34.99,
                    image: "",
                    strategy: "Momentum",
                    created_at: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString()
                },
                {
                    id: 5,
                    name: "Scalper Pro",
                    creator: { name: "FastTrades" },
                    category: "digit",
                    rating: 4.3,
                    performance: "+8.7%",
                    users: 634,
                    description: "High-frequency scalping strategy with micro positions and rapid profit-taking.",
                    is_favorite: false,
                    isNew: false,
                    status: "inactive",
                    price: 149.99,
                    rent_price: 14.99,
                    image: "",
                    strategy: "Scalping",
                    created_at: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString()
                },
                {
                    id: 6,
                    name: "Arbitrage Master",
                    creator: { name: "ProfitSeeker" },
                    category: "premium",
                    rating: 4.9,
                    performance: "+7.9%",
                    users: 521,
                    description: "Exploits price differences across multiple exchanges with lightning-fast execution.",
                    is_favorite: true,
                    isNew: false,
                    status: "active",
                    price: 499.99,
                    rent_price: 49.99,
                    image: "",
                    strategy: "Arbitrage",
                    created_at: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString()
                }
            ];
        }

        // Update marketplace stats
        function updateMarketplaceStats(bots) {
            const totalBots = bots.length;
            const activeBots = bots.filter(bot => bot.status === 'active').length;

            // Count bots created in the last 7 days (assuming they're marked as isNew or recently created)
            const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            const newBots = bots.filter(bot => {
                const isNewFlag = bot.isNew || false;
                const createdDate = new Date(bot.created_at || Date.now());
                return isNewFlag || createdDate >= oneWeekAgo;
            }).length;

            totalBotsCount.textContent = totalBots;
            activeBotsCount.textContent = activeBots;
            newBotsCount.textContent = newBots;
        }

        // Apply all filters
        function applyFilters() {
            let result = [...window.botsData];

            // Apply category filter
            if (currentCategory !== 'all') {
                result = result.filter(bot => bot.category === currentCategory);
            }

            // Apply search filter
            if (currentSearch.trim()) {
                const searchLower = currentSearch.toLowerCase();
                result = result.filter(bot =>
                    bot.name.toLowerCase().includes(searchLower) ||
                    bot.description.toLowerCase().includes(searchLower) ||
                    (bot.creator && bot.creator.name && bot.creator.name.toLowerCase().includes(searchLower)) ||
                    (bot.strategy && bot.strategy.toLowerCase().includes(searchLower))
                );
            }

            // Apply sort
            result = sortBots(result, currentSort);

            filteredBots = result;
            renderBotsGrid();
        }

        // Sort bots
        function sortBots(bots, criteria) {
            const sorted = [...bots];

            switch (criteria) {
                case 'newest':
                    sorted.sort((a, b) => {
                        const dateA = new Date(a.created_at || 0);
                        const dateB = new Date(b.created_at || 0);
                        return dateB - dateA;
                    });
                    break;
                case 'popular':
                    sorted.sort((a, b) => (b.users || 0) - (a.users || 0));
                    break;
                case 'rating':
                    sorted.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                    break;
                case 'performance':
                    sorted.sort((a, b) => {
                        const aPerf = parseFloat((a.performance || '+0%').replace('%', '').replace('+', ''));
                        const bPerf = parseFloat((b.performance || '+0%').replace('%', '').replace('+', ''));
                        return bPerf - aPerf;
                    });
                    break;
                case 'price-low':
                    sorted.sort((a, b) => (a.price || 0) - (b.price || 0));
                    break;
                case 'price-high':
                    sorted.sort((a, b) => (b.price || 0) - (a.price || 0));
                    break;
            }

            return sorted;
        }

        // Render bots grid - Using EXACT SAME structure as your reference
        function renderBotsGrid() {
            if (filteredBots.length === 0) {
                noResults.classList.remove('hidden');
                botsGrid.classList.add('hidden');
                return;
            }

            botsGrid.classList.remove('hidden');
            noResults.classList.add('hidden');

            botsGrid.innerHTML = '';

            filteredBots.forEach(bot => {
                const botCard = createBotCard(bot);
                botsGrid.appendChild(botCard);
            });

            attachBotCardListeners();
        }

        // Create bot card HTML - Using EXACT SAME structure as your reference
        function createBotCard(bot) {
            const botName = bot.name || 'Unnamed Bot';
            const botCreator = bot.creator || {};
            const botCreatorName = botCreator.name || 'Unknown';
            const botPrice = bot.price || 0;
            const botRentPrice = bot.rent_price || 0;
            const botStrategy = bot.strategy || 'AI Trading';
            const botStatus = bot.status || 'inactive';
            const botId = bot.id || '';
            const botImage = bot.image || '';
            const isFavorite = bot.is_favorite || false;

            // Format prices - same as reference
            function formatPrice(price) {
                if (!price) return 'Free';
                return `$${price.toLocaleString()}`;
            }

            function formatRentPrice(price) {
                if (!price) return '';
                return `$${price}/month`;
            }

            // Background image style - same as reference
            const bgImageStyle = botImage
                ? `background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.9)), url('${botImage}'); background-size: cover; background-position: center;`
                : `background: linear-gradient(135deg, #ff4500 0%, #1a1a1a 100%);`;

            // Create card HTML - EXACT SAME as your reference
            const card = document.createElement('div');
            card.className = 'bg-dark-800 rounded-xl border border-dark-700 overflow-hidden card-hover relative min-h-[320px]';
            card.innerHTML = `
            <!-- Background Image with Gradient Overlay -->
            <div class="absolute inset-0 rounded-xl" style="${bgImageStyle}"></div>
            
            <!-- Gradient Overlay for better text readability -->
            <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/60 to-transparent rounded-xl"></div>
            
            <!-- Content Container -->
            <div class="relative z-10 h-full flex flex-col p-5">
                <!-- Top Row: Status + Favorite -->
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <span class="bg-${botStatus === 'active' ? 'green' : 'red'}-500/90 text-${botStatus === 'active' ? 'green' : 'red'}-500 text-xs font-medium px-2 py-1 rounded border border-${botStatus === 'active' ? 'green' : 'red'}-500/30">
                            ${botStatus === 'active' ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                    <button class="favorite-btn text-lg ${isFavorite ? 'text-red-500' : 'text-white/70'} hover:text-red-500 transition-colors bg-black/30 rounded-full p-2" data-bot-id="${botId}">
                        <i class="fas fa-heart"></i>
                    </button>
                </div>
                
                <!-- Bot Info - Takes remaining space -->
                <div class="flex-1 flex flex-col justify-end">
                    <!-- Bot Name and Creator -->
                    <div class="mb-3">
                        <h3 class="text-xl font-bold text-white mb-1">${botName}</h3>
                        <div class="flex items-center text-white/80 text-sm">
                            <i class="fas fa-user mr-2"></i>
                            <span class="truncate">by ${botCreatorName}</span>
                        </div>
                    </div>
                    
                    <!-- Strategy Info -->
                    <div class="mb-4">
                        <div class="flex items-center text-white/80 text-sm">
                            <i class="fas fa-brain mr-2"></i>
                            <span>${botStrategy} Strategy</span>
                        </div>
                    </div>
                    
                    <!-- Compact Pricing Section -->
                    <div class="mb-4 grid ${(botPrice > 0 && botRentPrice > 0) ? 'grid-cols-2' : 'grid-cols-1'} gap-2">
                        ${botPrice > 0 ? `
                        <div class="bg-black/50 backdrop-blur-sm rounded-lg p-2 border border-white/10">
                            <p class="text-primary-400 font-semibold text-sm">${formatPrice(botPrice)}</p>
                            <p class="text-white/60 text-xs">One-time buy</p>
                        </div>
                        ` : ''}
                        
                        ${botRentPrice > 0 ? `
                        <div class="bg-black/50 backdrop-blur-sm rounded-lg p-2 border border-white/10">
                            <p class="text-purple-400 font-semibold text-sm">${formatRentPrice(botRentPrice)}</p>
                            <p class="text-white/60 text-xs">Monthly rent</p>
                        </div>
                        ` : ''}
                        
                        ${botPrice === 0 && botRentPrice === 0 ? `
                        <div class="bg-black/50 backdrop-blur-sm rounded-lg p-2 border border-green-500/30">
                            <p class="text-green-400 font-semibold text-sm">FREE</p>
                            <p class="text-white/60 text-xs">No cost to use</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="space-y-2">
                    <!-- Main Action Button -->
                    <div>
                        ${botPrice > 0 ? `
                        <button data-bot-id="${botId}" data-action="buy" data-price="${botPrice}" 
                                class="w-full bg-primary-500 hover:bg-primary-600 text-white px-4 py-3 rounded-lg font-medium transition-colors flex items-center justify-center shadow-lg">
                            <i class="fas fa-shopping-cart mr-2"></i> 
                            <span>Buy Now</span>
                        </button>
                        ` : ''}
                        
                        ${botRentPrice > 0 ? `
                        <button data-bot-id="${botId}" data-action="rent" data-price="${botRentPrice}" 
                                class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-3 rounded-lg font-medium transition-colors flex items-center justify-center shadow-lg">
                            <i class="fas fa-calendar-alt mr-2"></i> 
                            <span>Rent Now</span>
                        </button>
                        ` : ''}
                        
                        ${botPrice === 0 && botRentPrice === 0 ? `
                        <button data-bot-id="${botId}" data-action="use-free" 
                                class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg font-medium transition-colors flex items-center justify-center shadow-lg">
                            <i class="fas fa-play mr-2"></i> 
                            <span>Use Free</span>
                        </button>
                        ` : ''}
                    </div>
                    
                    <!-- Demo Button - Secondary style -->
                    <button data-bot-id="${botId}" data-action="demo" 
                            class="w-full bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center border border-white/20 backdrop-blur-sm">
                        <i class="fas fa-vial mr-2"></i> 
                        <span>Try Demo (Free)</span>
                    </button>
                </div>
            </div>
        `;

            return card;
        }

        // Attach event listeners to bot cards - same as reference
        function attachBotCardListeners() {
            // Favorite buttons
            document.querySelectorAll('.favorite-btn').forEach(button => {
                button.addEventListener('click', async function (e) {
                    e.stopPropagation();
                    const botId = this.dataset.botId;

                    try {
                        const response = await authFetch(`/api/user/favorite/${botId}`, {
                            method: 'POST'
                        });

                        if (response.is_favorite) {
                            this.classList.remove('text-white/70');
                            this.classList.add('text-red-500');
                            showNotification('Added to favorites', 'success');
                        } else {
                            this.classList.remove('text-red-500');
                            this.classList.add('text-white/70');
                            showNotification('Removed from favorites', 'info');
                        }
                    } catch (error) {
                        console.error('Failed to toggle favorite:', error);
                        showNotification('Failed to update favorites', 'error');
                    }
                });
            });

            // Action buttons (Buy/Rent/Free/Demo)
            document.querySelectorAll('button[data-action]').forEach(button => {
                button.addEventListener('click', async function () {
                    const botId = this.dataset.botId;
                    const action = this.dataset.action;
                    const price = this.dataset.price;

                    loadingSpinner.classList.remove('hidden');
                    const originalText = this.innerHTML;
                    this.innerHTML = '<i class="fas fa-circle-notch animate-spin mr-2"></i>';
                    this.disabled = true;

                    try {
                        switch (action) {
                            case 'demo':
                                await handleDemoAction(botId);
                                break;
                            case 'buy':
                                await handleBuyAction(botId, price);
                                break;
                            case 'rent':
                                await handleRentAction(botId, price);
                                break;
                            case 'use-free':
                                await handleFreeAction(botId);
                                break;
                        }
                    } catch (error) {
                        console.error('Action failed:', error);
                        showNotification(`Error: ${error.message}`, 'error');
                    } finally {
                        setTimeout(() => {
                            loadingSpinner.classList.add('hidden');
                            this.innerHTML = originalText;
                            this.disabled = false;
                        }, 1000);
                    }
                });
            });
        }

        // Action handlers - same as reference
        async function handleDemoAction(botId) {
            try {
                showNotification('Starting demo mode...', 'info');
                setTimeout(() => {
                    window.location.href = `/bots/${botId}?mode=demo`;
                }, 500);
            } catch (error) {
                console.error('Demo action failed:', error);
                throw error;
            }
        }

        async function handleBuyAction(botId, price) {
            try {
                showNotification('Redirecting to purchase...', 'info');
                setTimeout(() => {
                    window.location.href = `/payment/buy/${botId}?amount=${price}`;
                }, 500);
            } catch (error) {
                console.error('Buy action failed:', error);
                throw error;
            }
        }

        async function handleRentAction(botId, price) {
            try {
                showNotification('Redirecting to rental...', 'info');
                setTimeout(() => {
                    window.location.href = `/payment/rent/${botId}?amount=${price}&period=monthly`;
                }, 500);
            } catch (error) {
                console.error('Rent action failed:', error);
                throw error;
            }
        }

        async function handleFreeAction(botId) {
            try {
                const response = await authFetch(`/api/bots/${botId}/activate-free`, {
                    method: 'POST'
                });

                showNotification('Free bot activated successfully!', 'success');

                setTimeout(() => {
                    window.location.href = './mybots';
                }, 1000);

            } catch (error) {
                console.error('Failed to activate free bot:', error);
                throw error;
            }
        }

        // Show notification - same as reference
        function showNotification(message, type = 'info') {
            const existingNotification = document.getElementById('global-notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.id = 'global-notification';
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300 ${type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                    type === 'info' ? 'bg-blue-500 text-white' :
                        type === 'warning' ? 'bg-yellow-500 text-white' :
                            'bg-primary-500 text-white'
                }`;
            notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} mr-3"></i>
                <span>${message}</span>
            </div>
        `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Setup event listeners for marketplace specific features
        function setupEventListeners() {
            // Category filter buttons
            categoryFilters.forEach(button => {
                button.addEventListener('click', function () {
                    categoryFilters.forEach(btn => btn.classList.remove('active', 'bg-primary-500/20', 'text-primary-500', 'border-primary-500/30'));
                    this.classList.add('active', 'bg-primary-500/20', 'text-primary-500', 'border-primary-500/30');
                    currentCategory = this.dataset.category;
                    applyFilters();
                });
            });

            // Search input
            searchInput.addEventListener('input', debounce(() => {
                currentSearch = searchInput.value;
                applyFilters();
            }, 300));

            // Sort select
            sortSelect.addEventListener('change', () => {
                currentSort = sortSelect.value;
                applyFilters();
            });
        }

        // Debounce function for search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', async () => {
            // Load user profile
            await loadUserProfile();

            // Setup event listeners
            setupEventListeners();

            // Fetch bots from API
            await fetchBots();
        });

        // Auto-refresh user data every 5 minutes
        setInterval(async () => {
            try {
                await loadUserProfile();
            } catch (error) {
                console.error('Auto-refresh failed:', error);
            }
        }, 300000);
    </script>
</body>

</html>