<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlgoCDK - User Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF4500',
                        secondary: '#FF6347',
                        success: '#00C851',
                        danger: '#FF4444',
                        warning: '#FFBB33',
                        dark: '#0D1421',
                        darker: '#0A0E1A',
                        accent: '#1E293B'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .form-input {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255, 69, 0, 0.2);
            transition: all 0.3s ease;
        }

        .form-input:focus {
            border-color: #FF4500;
            box-shadow: 0 0 0 2px rgba(255, 69, 0, 0.1);
        }
    </style>
</head>

<body class="bg-dark text-gray-100 min-h-screen">
    <!-- Top Navigation Bar -->
    <nav class="bg-darker border-b border-gray-700 py-3 px-6 flex justify-between items-center">
        <div class="flex items-center">
            <a href="/" class="text-xl font-bold text-white flex items-center">
                <div class="w-8 h-8 rounded-lg bg-primary flex items-center justify-center mr-2">
                    <i class="fas fa-robot text-white text-sm"></i>
                </div>
                Algocdk
            </a>
        </div>

        <div class="flex items-center space-x-4">
            <div class="relative">
                <button id="userMenuButton" class="flex items-center space-x-2 focus:outline-none">
                    <div id="userAvatar"
                        class="w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white font-medium">
                        <i class="fas fa-user"></i>
                    </div>
                    <span id="userName" class="hidden md:block">Loading...</span>
                    <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                </button>

                <!-- User Dropdown -->
                <div id="userDropdown"
                    class="absolute right-0 mt-2 w-56 bg-darker rounded-lg shadow-xl border border-gray-700 hidden z-10">
                    <div class="p-4 border-b border-gray-700">
                        <div class="flex items-center space-x-3">
                            <div id="dropdownAvatar"
                                class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white font-medium">
                                <i class="fas fa-user"></i>
                            </div>
                            <div>
                                <h3 id="dropdownName" class="font-medium text-white">Loading...</h3>
                                <p id="dropdownEmail" class="text-xs text-gray-400 truncate max-w-[150px]">Loading...</p>
                            </div>
                        </div>
                    </div>
                    <div class="py-2">
                        <a href="/profile"
                            class="profile-dropdown-item block px-4 py-2.5 text-sm text-gray-300 hover:text-white hover:bg-accent transition-colors flex items-center">
                            <i class="fas fa-user-circle mr-3 text-primary"></i>
                            Profile
                        </a>
                        <a href="/settings"
                            class="profile-dropdown-item block px-4 py-2.5 text-sm text-gray-300 hover:text-white hover:bg-accent transition-colors flex items-center">
                            <i class="fas fa-cog mr-3 text-gray-400"></i>
                            Settings
                        </a>
                        <a href="/app"
                            class="profile-dropdown-item block px-4 py-2.5 text-sm text-gray-300 hover:text-white hover:bg-accent transition-colors flex items-center">
                            <i class="fas fa-chart-line mr-3 text-gray-400"></i>
                            Trading App
                        </a>
                        <div class="border-t border-gray-700 my-1"></div>
                        <a href="#" id="logoutButton"
                            class="profile-dropdown-item block px-4 py-2.5 text-sm text-red-500 hover:bg-accent transition-colors flex items-center">
                            <i class="fas fa-sign-out-alt mr-3"></i>Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto p-3 sm:p-6">
        <!-- Profile Header -->
        <div class="mb-6 sm:mb-8">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4 sm:mb-6">
                <div class="mb-4 sm:mb-0">
                    <h1 class="text-2xl sm:text-3xl font-bold text-white mb-2">User Profile</h1>
                    <p class="text-gray-400 text-sm sm:text-base">Manage your personal information</p>
                </div>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                    <button id="editProfileBtn"
                        class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center">
                        <i class="fas fa-edit mr-2"></i> Edit Profile
                    </button>
                    <button id="saveProfileBtn" style="display: none;"
                        class="bg-success hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center">
                        <i class="fas fa-save mr-2"></i> Save Changes
                    </button>
                    <button id="cancelEditBtn" style="display: none;"
                        class="bg-accent hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center border border-gray-600">
                        <i class="fas fa-times mr-2"></i> Cancel
                    </button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-gray-700 mb-6 sm:mb-8 overflow-x-auto">
                <button
                    class="tab-button active px-3 sm:px-4 py-3 font-medium text-sm border-b-2 border-primary text-primary whitespace-nowrap">
                    <i class="fas fa-user mr-2"></i> Personal Info
                </button>
                <button id="securityTab"
                    class="tab-button px-3 sm:px-4 py-3 font-medium text-sm text-gray-400 hover:text-white whitespace-nowrap">
                    <i class="fas fa-shield-alt mr-2"></i> Security
                </button>
            </div>
        </div>

        <!-- Personal Info Section -->
        <div id="personalInfoSection" class="fade-in">
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 lg:gap-8">
                <!-- Left Column: Account Info -->
                <div class="xl:col-span-1">
                    <div class="bg-darker rounded-xl border border-gray-700 p-4 sm:p-6">
                        <div class="flex flex-col items-center mb-4 sm:mb-6">
                            <div id="profileInitials"
                                class="w-24 h-24 sm:w-32 sm:h-32 rounded-full bg-primary flex items-center justify-center text-white text-2xl sm:text-4xl font-bold mb-3 sm:mb-4 shadow-lg">
                                <!-- Initials will be loaded here -->
                            </div>
                            <h3 class="text-lg sm:text-xl font-bold text-white text-center" id="displayFullName">Loading...</h3>
                            <p class="text-gray-400 text-sm mt-1 text-center break-all" id="displayEmail">Loading...</p>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <h3 class="font-medium text-white mb-2 text-sm sm:text-base">Account Status</h3>
                                <div class="flex items-center">
                                    <div class="w-2 h-2 rounded-full bg-green-500 mr-2 animate-pulse"></div>
                                    <span class="text-green-500 text-sm">Active</span>
                                </div>
                            </div>

                            <div>
                                <h3 class="font-medium text-white mb-2 text-sm sm:text-base">Member Since</h3>
                                <p id="memberSince" class="text-gray-400 text-sm">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Profile Form -->
                <div class="xl:col-span-2">
                    <div class="bg-darker rounded-xl border border-gray-700 p-4 sm:p-6 mb-6">
                        <h2 class="text-lg sm:text-xl font-bold text-white mb-4 sm:mb-6">Personal Information</h2>

                        <form id="profileForm">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                                <div class="sm:col-span-2 sm:col-span-1">
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Full Name</label>
                                    <input type="text" id="profileFullName" name="full_name"
                                        class="w-full form-input px-3 sm:px-4 py-2 rounded-lg text-white bg-accent border-gray-600 text-sm sm:text-base"
                                        placeholder="Enter your full name" readonly>
                                </div>

                                <div class="sm:col-span-2 sm:col-span-1">
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Email Address</label>
                                    <div class="flex items-center">
                                        <p id="profileEmail" class="text-white font-medium text-sm sm:text-base break-all">Loading...</p>
                                    </div>
                                </div>

                                <div class="sm:col-span-2 sm:col-span-1">
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Phone Number</label>
                                    <input type="tel" id="profilePhone" name="phone"
                                        class="w-full form-input px-3 sm:px-4 py-2 rounded-lg text-white bg-accent border-gray-600 text-sm sm:text-base"
                                        placeholder="Enter phone number" readonly>
                                </div>

                                <div class="sm:col-span-2 sm:col-span-1">
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Country</label>
                                    <div class="flex items-center">
                                        <p id="profileCountry" class="text-white font-medium text-sm sm:text-base">Loading...</p>
                                        <span class="ml-2 text-xs text-gray-500">(Auto-detected)</span>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Account Summary -->
                    <div class="bg-darker rounded-xl border border-gray-700 p-4 sm:p-6">
                        <h2 class="text-lg sm:text-xl font-bold text-white mb-4 sm:mb-6">Account Summary</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="text-center p-4 bg-accent rounded-lg">
                                <div class="text-xl sm:text-2xl font-bold text-success" id="activeBotCount">0</div>
                                <div class="text-xs sm:text-sm text-gray-400">Active Bots</div>
                            </div>
                            <div class="text-center p-4 bg-accent rounded-lg">
                                <div class="text-xl sm:text-2xl font-bold text-primary" id="totalProfit">$0</div>
                                <div class="text-xs sm:text-sm text-gray-400">Total Profit</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Section -->
        <div id="securitySection" class="hidden fade-in">
            <div class="bg-darker rounded-xl border border-gray-700 p-4 sm:p-6">
                <h2 class="text-lg sm:text-xl font-bold text-white mb-4 sm:mb-6">Security Settings</h2>
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center p-4 border border-gray-700 rounded-lg space-y-3 sm:space-y-0">
                    <div>
                        <h3 class="font-medium text-white text-sm sm:text-base">Password</h3>
                        <p class="text-gray-400 text-xs sm:text-sm">Change your account password</p>
                    </div>
                    <button id="changePasswordBtn"
                        class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors w-full sm:w-auto">
                        Change Password
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="bg-darker rounded-xl p-4 sm:p-6 w-full max-w-md border border-gray-600">
            <div class="flex justify-between items-center mb-4 sm:mb-6">
                <h3 class="text-lg sm:text-xl font-bold text-white">Change Password</h3>
                <button id="closePasswordModal" class="text-gray-400 hover:text-white p-1">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="passwordForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Current Password</label>
                        <input type="password" id="currentPassword"
                            class="w-full form-input px-3 sm:px-4 py-2 rounded-lg text-white text-sm sm:text-base" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">New Password</label>
                        <input type="password" id="newPassword"
                            class="w-full form-input px-3 sm:px-4 py-2 rounded-lg text-white text-sm sm:text-base" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Confirm New Password</label>
                        <input type="password" id="confirmPassword"
                            class="w-full form-input px-3 sm:px-4 py-2 rounded-lg text-white text-sm sm:text-base" required>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 mt-6 sm:mt-8">
                    <button type="button" id="cancelPassword"
                        class="px-4 py-2 text-sm font-medium text-gray-400 hover:text-white order-2 sm:order-1">
                        Cancel
                    </button>
                    <button type="submit"
                        class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg text-sm font-medium order-1 sm:order-2">
                        Update Password
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Authentication check
        if (!localStorage.getItem('token')) {
            window.location.href = '/';
        }

        // Utility function for authenticated fetch requests
        async function authFetch(url, options = {}) {
            const token = localStorage.getItem('token');
            if (!token) {
                throw new Error('No authentication token found');
            }

            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                },
            };

            const response = await fetch(url, { ...defaultOptions, ...options });

            if (response.status === 401) {
                localStorage.removeItem('token');
                localStorage.removeItem('userData');
                window.location.href = '/';
                throw new Error('Session expired. Please login again.');
            }

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || errorData.message || `Request failed: ${response.status}`);
            }

            return response.json();
        }

        // Function to get user initials
        function getUserInitials(name) {
            if (!name || name === 'Loading...') return 'U';
            const nameParts = name.split(' ');
            if (nameParts.length === 1) {
                return nameParts[0].charAt(0).toUpperCase();
            }
            return (nameParts[0].charAt(0) + nameParts[nameParts.length - 1].charAt(0)).toUpperCase();
        }

        // Load user profile data
        async function loadUserProfile() {
            try {
                const response = await authFetch('/api/user/profile');
                const userData = response.data || response.user || response;

                updateProfileUI(userData);
                localStorage.setItem('userData', JSON.stringify(userData));
                
                // Load user stats
                await loadUserStats();

            } catch (error) {
                console.error('Failed to load profile:', error);
                const cachedData = localStorage.getItem('userData');
                if (cachedData) {
                    try {
                        const userData = JSON.parse(cachedData);
                        updateProfileUI(userData);
                    } catch (e) {
                        console.error('Failed to parse cached data:', e);
                    }
                }
            }
        }
        
        // Load user statistics
        async function loadUserStats() {
            try {
                // Get user's bots with real profit data
                const response = await authFetch('/api/user/bots');
                const data = response.bots || response.data || response || [];
                
                const activeBots = data.filter(bot => bot.status === 'active').length;
                const totalProfit = response.total_profit || 0;
                
                document.getElementById('activeBotCount').textContent = activeBots;
                document.getElementById('totalProfit').textContent = `$${totalProfit.toLocaleString()}`;
                
            } catch (error) {
                // Fallback to 0 values if API fails
                document.getElementById('activeBotCount').textContent = '0';
                document.getElementById('totalProfit').textContent = '$0';
            }
        }

        // Update profile UI with user data
        function updateProfileUI(userData) {
            const userName = userData.full_name || userData.name || userData.username || 'User';
            const userEmail = userData.email || 'Not provided';
            const userInitials = getUserInitials(userName);

            // Update navigation
            document.getElementById('userName').textContent = userName;
            document.getElementById('userAvatar').textContent = userInitials;
            document.getElementById('dropdownName').textContent = userName;
            document.getElementById('dropdownEmail').textContent = userEmail;
            document.getElementById('dropdownAvatar').textContent = userInitials;

            // Update profile page
            document.getElementById('profileInitials').textContent = userInitials;
            document.getElementById('displayFullName').textContent = userName;
            document.getElementById('displayEmail').textContent = userEmail;

            // Update form fields
            document.getElementById('profileFullName').value = userName;
            document.getElementById('profileEmail').textContent = userEmail;
            document.getElementById('profilePhone').value = userData.phone || '';
            document.getElementById('profileCountry').textContent = userData.country || 'Unknown';

            // Format join date
            if (userData.created_at || userData.createdAt) {
                const joinDate = new Date(userData.created_at || userData.createdAt);
                document.getElementById('memberSince').textContent = joinDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } else {
                document.getElementById('memberSince').textContent = 'Not available';
            }
        }

        // Enable/disable form fields for editing
        function setEditMode(enabled) {
            const formFields = ['profileFullName', 'profilePhone'];
            
            formFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                field.readOnly = !enabled;
            });

            // Show/hide buttons with responsive display
            document.getElementById('editProfileBtn').style.display = enabled ? 'none' : 'flex';
            document.getElementById('saveProfileBtn').style.display = enabled ? 'flex' : 'none';
            document.getElementById('cancelEditBtn').style.display = enabled ? 'flex' : 'none';
        }

        // Save profile data
        async function saveProfile() {
            try {
                const formData = {
                    full_name: document.getElementById('profileFullName').value,
                    phone: document.getElementById('profilePhone').value
                };

                const response = await authFetch('/api/user/profile', {
                    method: 'PUT',
                    body: JSON.stringify(formData)
                });

                showNotification('Profile updated successfully', 'success');

                if (response.user) {
                    updateProfileUI(response.user);
                }

                setEditMode(false);

            } catch (error) {
                console.error('Failed to save profile:', error);
                showNotification('Failed to update profile: ' + error.message, 'error');
            }
        }

        // Tab switching functionality
        const tabs = {
            personal: document.getElementById('personalInfoSection'),
            security: document.getElementById('securitySection')
        };

        const tabButtons = document.querySelectorAll('.tab-button');

        tabButtons.forEach(button => {
            button.addEventListener('click', function () {
                tabButtons.forEach(btn => {
                    btn.classList.remove('active', 'border-primary', 'text-primary');
                    btn.classList.add('text-gray-400');
                });

                Object.values(tabs).forEach(section => {
                    section.classList.add('hidden');
                });

                this.classList.remove('text-gray-400');
                this.classList.add('active', 'border-primary', 'text-primary');

                const tabText = this.textContent.toLowerCase();
                if (tabText.includes('personal')) {
                    tabs.personal.classList.remove('hidden');
                } else if (tabText.includes('security')) {
                    tabs.security.classList.remove('hidden');
                }
            });
        });

        // Show notification
        function showNotification(message, type = 'info') {
            const existingNotification = document.querySelector('.notification-toast');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.className = `notification-toast fixed top-4 right-4 p-4 rounded-lg shadow-lg border z-50 transform transition-all duration-300`;

            let bgColor = 'bg-darker';
            let borderColor = 'border-gray-700';
            let icon = 'fas fa-info-circle';

            if (type === 'success') {
                bgColor = 'bg-green-500/20';
                borderColor = 'border-green-500/30';
                icon = 'fas fa-check-circle text-green-500';
            } else if (type === 'error') {
                bgColor = 'bg-red-500/20';
                borderColor = 'border-red-500/30';
                icon = 'fas fa-exclamation-circle text-red-500';
            }

            notification.className += ` ${bgColor} ${borderColor}`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="${icon} mr-3"></i>
                    <p class="text-white">${message}</p>
                </div>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function () {
            loadUserProfile();

            // User dropdown
            const userMenuButton = document.getElementById('userMenuButton');
            const userDropdown = document.getElementById('userDropdown');

            userMenuButton.addEventListener('click', (e) => {
                e.stopPropagation();
                userDropdown.classList.toggle('hidden');
            });

            document.addEventListener('click', (event) => {
                if (!userMenuButton.contains(event.target) && !userDropdown.contains(event.target)) {
                    userDropdown.classList.add('hidden');
                }
            });

            // Edit profile button
            document.getElementById('editProfileBtn').addEventListener('click', () => {
                setEditMode(true);
            });

            // Save profile button
            document.getElementById('saveProfileBtn').addEventListener('click', (e) => {
                e.preventDefault();
                saveProfile();
            });

            // Cancel edit button
            document.getElementById('cancelEditBtn').addEventListener('click', () => {
                setEditMode(false);
                const cachedData = localStorage.getItem('userData');
                if (cachedData) {
                    try {
                        const userData = JSON.parse(cachedData);
                        updateProfileUI(userData);
                    } catch (e) {
                        console.error('Failed to reload cached data:', e);
                    }
                }
            });

            // Password change functionality
            const changePasswordModal = document.getElementById('changePasswordModal');
            const changePasswordBtn = document.getElementById('changePasswordBtn');
            const closePasswordModal = document.getElementById('closePasswordModal');
            const cancelPassword = document.getElementById('cancelPassword');
            const passwordForm = document.getElementById('passwordForm');

            changePasswordBtn.addEventListener('click', () => {
                changePasswordModal.classList.remove('hidden');
            });

            closePasswordModal.addEventListener('click', () => {
                changePasswordModal.classList.add('hidden');
            });

            cancelPassword.addEventListener('click', () => {
                changePasswordModal.classList.add('hidden');
            });

            passwordForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (newPassword !== confirmPassword) {
                    showNotification('Passwords do not match', 'error');
                    return;
                }

                if (newPassword.length < 8) {
                    showNotification('Password must be at least 8 characters', 'error');
                    return;
                }

                try {
                    await authFetch('/api/user/reset-password', {
                        method: 'POST',
                        body: JSON.stringify({
                            currentPassword,
                            newPassword
                        })
                    });

                    showNotification('Password updated successfully', 'success');
                    changePasswordModal.classList.add('hidden');
                    passwordForm.reset();

                } catch (error) {
                    showNotification('Failed to update password: ' + error.message, 'error');
                }
            });

            // Logout functionality
            document.getElementById('logoutButton').addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('token');
                localStorage.removeItem('userData');
                window.location.href = '/';
            });
        });
    </script>
</body>

</html>