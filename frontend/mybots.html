<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Bots | AlgoCDK - AI Trading Platform</title>
    <link rel="stylesheet" href="output.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF4500',
                        secondary: '#FF6347',
                        success: '#00C851',
                        danger: '#FF4444',
                        warning: '#FFBB33',
                        dark: '#0D1421',
                        darker: '#0A0E1A',
                        accent: '#1E293B'
                    }
                }
            }
        }
    </script>
    <style>
        /* Theme Variables */
        :root {
            --bg-primary: #0e1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #1f2430;
            --border-color: #2b2f3a;
            --text-primary: #d1d4dc;
            --text-secondary: #8b949e;
            --accent-primary: #FF4500;
            --accent-secondary: #FF6347;
            --success: #00c176;
            --danger: #ff4d4f;
            --warning: #ffa500;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }

        /* Navigation */
        .navbar {
            background: rgba(22, 27, 34, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
        }

        /* Cards */
        .card-hover {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 69, 0, 0.4);
        }

        .stats-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .stats-card:hover {
            border-color: rgba(255, 69, 0, 0.3);
            transform: translateY(-2px);
        }

        /* Form Elements */
        .form-input {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(255, 69, 0, 0.1);
        }

        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            border: none;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(255, 69, 0, 0.3);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: rgba(255, 69, 0, 0.1);
            border-color: var(--accent-primary);
        }

        /* Filter buttons */
        .filter-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .filter-btn.active {
            background: rgba(255, 69, 0, 0.2);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bot-running {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 69, 0, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 69, 0, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 69, 0, 0);
            }
        }

        /* Glass effect */
        .glass-effect {
            background: rgba(22, 27, 34, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
        }

        /* Status indicators */
        .status-active {
            background: rgba(0, 193, 118, 0.2);
            color: var(--success);
            border: 1px solid rgba(0, 193, 118, 0.3);
        }

        .status-paused {
            background: rgba(255, 165, 0, 0.2);
            color: var(--warning);
            border: 1px solid rgba(255, 165, 0, 0.3);
        }

        .status-expired {
            background: rgba(255, 77, 79, 0.2);
            color: var(--danger);
            border: 1px solid rgba(255, 77, 79, 0.3);
        }

        /* Bot card enhancements */
        .bot-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .bot-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .bot-card:hover::before {
            opacity: 1;
        }

        /* Loading spinner */
        .loading-spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--accent-primary);
        }
    </style>
</head>

<body>
    <!-- Top Navigation Bar -->
    <nav class="navbar py-3 px-6 flex justify-between items-center sticky top-0 z-10">
        <div class="flex items-center">
            <a href="#" class="text-xl font-bold flex items-center" style="color: var(--text-primary);">
                <div class="w-8 h-8 rounded-lg flex items-center justify-center mr-2" style="background: var(--accent-primary);">
                    <i class="fas fa-robot text-white text-sm"></i>
                </div>
                AlgoCDK
            </a>
        </div>

        <!-- Search Bar -->
        <div class="hidden md:flex flex-1 max-w-md mx-4">
            <div class="relative w-full">
                <input type="text" id="searchInput" placeholder="Search my bots..."
                    class="w-full pl-10 pr-4 py-2 form-input rounded-lg">
                <i class="fas fa-search absolute left-3 top-3" style="color: var(--text-secondary);"></i>
            </div>
        </div>

        <div class="flex items-center space-x-4">
            <!-- Mobile Search Button -->
            <button class="md:hidden transition-colors" style="color: var(--text-secondary);" id="mobileSearchBtn">
                <i class="fas fa-search"></i>
            </button>

            <!-- Navigation Links -->
            <div class="hidden md:flex items-center space-x-4">
                <a href="mybots" class="font-medium" style="color: var(--accent-primary);">MyBots</a>
                <a href="botstore" class="transition-colors" style="color: var(--text-secondary);" onmouseover="this.style.color='var(--text-primary)'" onmouseout="this.style.color='var(--text-secondary)'">Marketplace</a>
                <a href="#" class="transition-colors" style="color: var(--text-secondary);" onmouseover="this.style.color='var(--text-primary)'" onmouseout="this.style.color='var(--text-secondary)'">Trade History</a>
                <a href="support" class="transition-colors" style="color: var(--text-secondary);" onmouseover="this.style.color='var(--text-primary)'" onmouseout="this.style.color='var(--text-secondary)'">Support</a>
            </div>

            <!-- User Menu -->
            <div class="relative">
                <button id="userMenuButton" class="flex items-center space-x-2 focus:outline-none">
                    <div id="userAvatar"
                        class="w-8 h-8 rounded-full flex items-center justify-center text-white font-medium" style="background: var(--accent-primary);">
                        <i class="fas fa-user"></i>
                    </div>
                    <span id="userName" class="hidden md:block">Loading...</span>
                    <i class="fas fa-chevron-down text-xs" style="color: var(--text-secondary);"></i>
                </button>

                <!-- User Dropdown -->
                <div id="userDropdown"
                    class="absolute right-0 mt-2 w-48 rounded-lg shadow-lg hidden z-10 glass-effect">
                    <div class="py-1">
                        <a href="profile"
                            class="block px-4 py-2 text-sm transition-colors" style="color: var(--text-secondary);" onmouseover="this.style.background='var(--bg-tertiary)'; this.style.color='var(--text-primary)'" onmouseout="this.style.background='transparent'; this.style.color='var(--text-secondary)'">Profile</a>
                        <a href="mybots"
                            class="block px-4 py-2 text-sm transition-colors" style="color: var(--text-secondary);" onmouseover="this.style.background='var(--bg-tertiary)'; this.style.color='var(--text-primary)'" onmouseout="this.style.background='transparent'; this.style.color='var(--text-secondary)'">My Bots</a>
                        <a href="settings"
                            class="block px-4 py-2 text-sm transition-colors" style="color: var(--text-secondary);" onmouseover="this.style.background='var(--bg-tertiary)'; this.style.color='var(--text-primary)'" onmouseout="this.style.background='transparent'; this.style.color='var(--text-secondary)'">Settings</a>
                        <a id="adminDashboardLink" href="admin_dashboard.html" style="display:none"
                            class="block px-4 py-2 text-sm transition-colors" style="color: var(--text-secondary);" onmouseover="this.style.background='var(--bg-tertiary)'; this.style.color='var(--text-primary)'" onmouseout="this.style.background='transparent'; this.style.color='var(--text-secondary)'">
                            <i class="fas fa-user-shield mr-2"></i>Admin Dashboard</a>
                        <a id="superadminDashboardLink" href="superadmin_dashboard.html" style="display:none"
                            class="block px-4 py-2 text-sm transition-colors" style="color: var(--text-secondary);" onmouseover="this.style.background='var(--bg-tertiary)'; this.style.color='var(--text-primary)'" onmouseout="this.style.background='transparent'; this.style.color='var(--text-secondary)'">
                            <i class="fas fa-crown mr-2"></i>SuperAdmin Dashboard</a>
                        <div class="my-1" style="border-top: 1px solid var(--border-color);"></div>
                        <a href="#" id="logoutButton"
                            class="block px-4 py-2 text-sm transition-colors" style="color: var(--danger);" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='transparent'">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6 fade-in">
        <!-- Quick Actions Bar -->
        <section class="mb-6">
            <div class="flex flex-col sm:flex-row gap-4">
                <button class="btn-primary px-4 py-2 rounded-lg flex items-center justify-center">
                    <i class="fas fa-play mr-2"></i> Start All Active
                </button>
                <button class="btn-secondary px-4 py-2 rounded-lg flex items-center justify-center">
                    <i class="fas fa-pause mr-2"></i> Pause All
                </button>
                <button class="btn-secondary px-4 py-2 rounded-lg flex items-center justify-center">
                    <i class="fas fa-chart-line mr-2"></i> View Analytics
                </button>
                <a href="botstore" class="btn-primary px-4 py-2 rounded-lg flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i> Add Bot
                </a>
            </div>
        </section>

        <!-- Header Section -->
        <section class="mb-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                <div>
                    <h1 class="text-3xl font-bold mb-2" style="color: var(--text-primary);">My Trading Bots</h1>
                    <p style="color: var(--text-secondary);">Manage and monitor your automated trading strategies</p>
                </div>
                <div class="mt-4 md:mt-0 flex items-center gap-3">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full" style="background: var(--success);"></div>
                        <span class="text-sm" style="color: var(--text-secondary);">Live Trading</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Stats Overview -->
        <section class="mb-8">
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="stats-card rounded-xl p-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="p-2 rounded-lg" style="background: rgba(0, 193, 118, 0.1);">
                            <i class="fas fa-robot text-sm" style="color: var(--success);"></i>
                        </div>
                        <span class="text-xs" style="color: var(--text-secondary);">Active</span>
                    </div>
                    <h3 class="text-xl font-bold" style="color: var(--text-primary);" id="totalBots">0</h3>
                    <p class="text-xs" style="color: var(--text-secondary);">Total Bots</p>
                </div>

                <div class="stats-card rounded-xl p-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="p-2 rounded-lg" style="background: rgba(255, 69, 0, 0.1);">
                            <i class="fas fa-dollar-sign text-sm" style="color: var(--accent-primary);"></i>
                        </div>
                        <span class="text-xs" style="color: var(--text-secondary);">Today</span>
                    </div>
                    <h3 class="text-xl font-bold" style="color: var(--text-primary);" id="todayPnL">+$0</h3>
                    <p class="text-xs" style="color: var(--text-secondary);">P&L</p>
                </div>

                <div class="stats-card rounded-xl p-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="p-2 rounded-lg" style="background: rgba(255, 165, 0, 0.1);">
                            <i class="fas fa-chart-line text-sm" style="color: var(--warning);"></i>
                        </div>
                        <span class="text-xs" style="color: var(--text-secondary);">Avg</span>
                    </div>
                    <h3 class="text-xl font-bold" style="color: var(--text-primary);" id="avgPerformance">+0.0%</h3>
                    <p class="text-xs" style="color: var(--text-secondary);">Performance</p>
                </div>

                <div class="stats-card rounded-xl p-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="p-2 rounded-lg" style="background: rgba(138, 43, 226, 0.1);">
                            <i class="fas fa-calendar text-sm" style="color: #8a2be2;"></i>
                        </div>
                        <span class="text-xs" style="color: var(--text-secondary);">Monthly</span>
                    </div>
                    <h3 class="text-xl font-bold" style="color: var(--text-primary);" id="monthlyCost">$0</h3>
                    <p class="text-xs" style="color: var(--text-secondary);">Cost</p>
                </div>
            </div>
        </section>

        <!-- Filters and Search -->
        <section class="mb-6">
            <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between">
                <div class="flex flex-wrap gap-2">
                    <button class="filter-btn active px-3 py-1.5 rounded-full text-sm font-medium" data-filter="all">
                        All
                    </button>
                    <button class="filter-btn px-3 py-1.5 rounded-full text-sm" data-filter="active">
                        <i class="fas fa-play mr-1"></i> Running
                    </button>
                    <button class="filter-btn px-3 py-1.5 rounded-full text-sm" data-filter="paused">
                        <i class="fas fa-pause mr-1"></i> Paused
                    </button>
                    <button class="filter-btn px-3 py-1.5 rounded-full text-sm" data-filter="rental">
                        <i class="fas fa-clock mr-1"></i> Rental
                    </button>
                </div>
                
                <div class="flex gap-3 w-full lg:w-auto">
                    <div class="relative flex-1 lg:w-64">
                        <input type="text" id="searchInput" placeholder="Search bots..."
                            class="w-full pl-10 pr-4 py-2 form-input rounded-lg text-sm">
                        <i class="fas fa-search absolute left-3 top-2.5 text-sm" style="color: var(--text-secondary);"></i>
                    </div>
                    <select id="sortSelect" class="form-input rounded-lg px-3 py-2 text-sm">
                        <option value="recent">Recent</option>
                        <option value="name">Name</option>
                        <option value="performance">Performance</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Bots Grid Section -->
        <section>
            <div id="loadingIndicator" class="flex justify-center items-center py-12">
                <div class="animate-spin rounded-full h-12 w-12 loading-spinner"></div>
                <span class="ml-3" style="color: var(--text-secondary);">Loading your bots...</span>
            </div>

            <div id="botsGrid" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <!-- Bot cards will be populated here by JavaScript -->
            </div>

            <div id="noBots" class="hidden text-center py-12">
                <i class="fas fa-robot text-5xl mb-4" style="color: var(--text-secondary);"></i>
                <h3 class="text-xl font-medium mb-2" style="color: var(--text-primary);">You don't have any bots yet</h3>
                <p class="mb-6" style="color: var(--text-secondary);">Start building your trading portfolio by exploring our marketplace</p>
                <a href="botstore"
                    class="btn-primary text-white px-6 py-3 rounded-lg font-medium">
                    Browse Marketplace
                </a>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="border-t py-8 mt-12" style="background: var(--bg-secondary); border-color: var(--border-color);">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <div class="flex items-center mb-2">
                        <div class="w-6 h-6 rounded-lg flex items-center justify-center mr-2" style="background: var(--accent-primary);">
                            <i class="fas fa-robot text-white text-xs"></i>
                        </div>
                        <span class="text-lg font-bold" style="color: var(--text-primary);">AlgoCDK</span>
                    </div>
                    <p class="text-sm" style="color: var(--text-secondary);">&copy; <span id="currentYear"></span> AlgoCDK. All rights reserved.</p>
                </div>
                <div class="flex space-x-6">
                    <a href="terms" class="text-sm transition-colors" style="color: var(--text-secondary);" onmouseover="this.style.color='var(--text-primary)'" onmouseout="this.style.color='var(--text-secondary)'">Terms</a>
                    <a href="privacy" class="text-sm transition-colors" style="color: var(--text-secondary);" onmouseover="this.style.color='var(--text-primary)'" onmouseout="this.style.color='var(--text-secondary)'">Privacy</a>
                    <a href="support" class="text-sm transition-colors" style="color: var(--text-secondary);" onmouseover="this.style.color='var(--text-primary)'" onmouseout="this.style.color='var(--text-secondary)'">Support</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Loading Spinner Template (Hidden by default) -->
    <div id="loadingSpinner" class="hidden fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0, 0, 0, 0.5);">
        <div class="rounded-xl p-6 flex flex-col items-center glass-effect">
            <div class="w-16 h-16 rounded-full animate-spin mb-4 loading-spinner"></div>
            <p style="color: var(--text-primary);">Processing...</p>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Set current year
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        // Authentication check
        if (!localStorage.getItem('token')) {
            window.location.href = '/';
        }

        // Utility function for authenticated fetch requests
        async function authFetch(url, options = {}) {
            const token = localStorage.getItem('token');
            if (!token) {
                throw new Error('No authentication token found');
            }

            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                },
            };

            const response = await fetch(url, { ...defaultOptions, ...options });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || errorData.message || `Request failed: ${response.status}`);
            }

            return response.json();
        }

        // User dropdown functionality
        const userMenuButton = document.getElementById('userMenuButton');
        const userDropdown = document.getElementById('userDropdown');

        userMenuButton.addEventListener('click', (e) => {
            e.stopPropagation();
            userDropdown.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (event) => {
            if (!userMenuButton.contains(event.target) && !userDropdown.contains(event.target)) {
                userDropdown.classList.add('hidden');
            }
        });

        // Logout functionality
        document.getElementById('logoutButton').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('token');
            localStorage.removeItem('userData');
            window.location.href = '/';
        });

        // Load user profile
        async function loadUserProfile() {
            try {
                const response = await authFetch('/api/user/profile');
                const userData = response.data || response.user || response;

                // Update user info
                const userName = document.getElementById('userName');
                const userAvatar = document.getElementById('userAvatar');

                if (userData.name) {
                    userName.textContent = userData.name;
                    userAvatar.textContent = userData.name.charAt(0).toUpperCase();
                }
                
                // Show dashboard links based on role
                const role = (userData.role || '').toString().toLowerCase();
                const adminLink = document.getElementById('adminDashboardLink');
                const superadminLink = document.getElementById('superadminDashboardLink');
                
                if (role.includes('admin') && adminLink) {
                    adminLink.style.display = 'block';
                }
                if (role.includes('superadmin') && superadminLink) {
                    superadminLink.style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load user profile:', error);
            }
        }

        // Load user's bots from backend
        async function loadUserBots() {
            try {
                console.log('Loading user bots...');

                let bots = [];

                try {
                    // Try user's bots endpoint
                    const response = await authFetch('/api/user/bots');
                    bots = response.bots || response.data || response || [];
                } catch (error) {
                    console.log('User bots endpoint not found, trying marketplace...');

                    // Fallback: get from marketplace and simulate ownership
                    const marketplaceResponse = await authFetch('/api/marketplace');
                    const allBots = marketplaceResponse.bots || [];

                    // Simulate some owned bots (first 3-6 bots)
                    const ownedBots = allBots.slice(0, Math.min(6, allBots.length)).map((bot, index) => ({
                        ...bot,
                        is_owned: true,
                        purchase_type: index % 2 === 0 ? 'purchased' : 'rental',
                        purchase_date: new Date(Date.now() - (index * 7 * 24 * 60 * 60 * 1000)).toISOString().split('T')[0],
                        expiration_date: index % 2 === 1 ? new Date(Date.now() + (30 * 24 * 60 * 60 * 1000)).toISOString().split('T')[0] : null,
                        status: ['active', 'active', 'paused', 'active', 'expired', 'active'][index] || 'active',
                        is_running: index % 3 === 0,
                        monthly_cost: bot.rent_price || 0,
                        total_cost: bot.price || 0
                    }));

                    bots = ownedBots;
                }

                console.log('User bots loaded:', bots);

                // Update stats
                updateStats(bots);

                // Load bots into grid
                displayBots(bots);

            } catch (error) {
                console.error('Failed to load user bots:', error);
                document.getElementById('loadingIndicator').innerHTML = `
                    <div class="text-center text-red-400 py-12">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>Failed to load your bots</p>
                        <p class="text-sm text-gray-400 mt-1">${error.message || 'Please try again later'}</p>
                        <button onclick="loadUserBots()" class="mt-4 bg-primary-500 text-white px-4 py-2 rounded-lg hover:bg-primary-600 transition-colors">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        // Update stats based on loaded bots
        function updateStats(bots) {
            const totalBots = bots.length;
            const activeBots = bots.filter(bot => bot.status === 'active').length;
            const runningBots = bots.filter(bot => bot.is_running).length;
            const monthlyCost = bots.reduce((sum, bot) => sum + (bot.monthly_cost || 0), 0);
            const avgPerformance = bots.length > 0
                ? `+${(bots.reduce((sum, bot) => {
                    const perf = parseFloat(bot.performance?.replace('%', '').replace('+', '')) || 0;
                    return sum + perf;
                }, 0) / bots.length).toFixed(1)}%`
                : '+0.0%';
            const todayPnL = Math.floor(Math.random() * 500) - 250; // Simulated daily P&L

            document.getElementById('totalBots').textContent = runningBots;
            document.getElementById('todayPnL').textContent = `${todayPnL >= 0 ? '+' : ''}$${todayPnL}`;
            document.getElementById('todayPnL').style.color = todayPnL >= 0 ? 'var(--success)' : 'var(--danger)';
            document.getElementById('avgPerformance').textContent = avgPerformance;
            document.getElementById('monthlyCost').textContent = `$${monthlyCost}`;
        }

        // Display bots in grid
        function displayBots(bots) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const botsGrid = document.getElementById('botsGrid');
            const noBots = document.getElementById('noBots');

            loadingIndicator.classList.add('hidden');

            if (!bots || bots.length === 0) {
                noBots.classList.remove('hidden');
                botsGrid.classList.add('hidden');
                return;
            }

            botsGrid.classList.remove('hidden');
            noBots.classList.add('hidden');
            botsGrid.innerHTML = '';

            bots.forEach(bot => {
                const botCard = createBotCard(bot);
                botsGrid.appendChild(botCard);
            });

            attachBotCardListeners();
        }

        // Create simplified bot card
        function createBotCard(bot) {
            const botName = bot.name || 'Unnamed Bot';
            const botCreator = bot.creator || {};
            const botCreatorName = botCreator.name || 'Unknown';
            const botStrategy = bot.strategy || 'AI Trading';
            const botStatus = bot.status || 'inactive';
            const botId = bot.id || '';
            const botImage = bot.image || '';
            const botPerformance = bot.performance || '+0%';
            const purchaseType = bot.purchase_type || 'purchased';
            const isRunning = bot.is_running || false;
            const price = bot.price || 0;
            const rentPrice = bot.rent_price || 0;

            const card = document.createElement('div');
            card.className = 'bot-card rounded-xl overflow-hidden card-hover relative';
            card.setAttribute('data-status', botStatus);
            card.setAttribute('data-purchase-type', purchaseType);
            card.setAttribute('data-bot-id', botId);

            card.innerHTML = `
                <div class="p-4">
                    <!-- Header -->
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));">
                                <i class="fas fa-robot text-white"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold" style="color: var(--text-primary);">${botName}</h3>
                                <p class="text-xs" style="color: var(--text-secondary);">by ${botCreatorName}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            ${isRunning ? `
                            <div class="flex items-center gap-1 px-2 py-1 rounded-full text-xs" style="background: rgba(0, 193, 118, 0.2); color: var(--success);">
                                <div class="w-2 h-2 rounded-full animate-pulse" style="background: var(--success);"></div>
                                Live
                            </div>
                            ` : `
                            <div class="flex items-center gap-1 px-2 py-1 rounded-full text-xs" style="background: rgba(139, 148, 158, 0.2); color: var(--text-secondary);">
                                <div class="w-2 h-2 rounded-full" style="background: var(--text-secondary);"></div>
                                Idle
                            </div>
                            `}
                        </div>
                    </div>

                    <!-- Performance -->
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="text-center">
                            <p class="text-xs" style="color: var(--text-secondary);">Performance</p>
                            <p class="font-semibold ${botPerformance.startsWith('+') ? 'text-green-400' : 'text-red-400'}">${botPerformance}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs" style="color: var(--text-secondary);">Type</p>
                            <p class="font-semibold text-xs" style="color: var(--text-primary);">${purchaseType === 'rental' ? 'Rental' : 'Owned'}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs" style="color: var(--text-secondary);">Cost</p>
                            <p class="font-semibold text-xs" style="color: var(--text-primary);">$${purchaseType === 'rental' ? rentPrice : price}</p>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-2">
                        ${botStatus === 'active' ? `
                        ${isRunning ? `
                        <button class="stop-bot-btn flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors" style="background: rgba(255, 77, 79, 0.2); color: var(--danger); border: 1px solid rgba(255, 77, 79, 0.3);">
                            <i class="fas fa-stop mr-1"></i> Stop
                        </button>
                        ` : `
                        <button class="run-bot-btn flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors" style="background: rgba(0, 193, 118, 0.2); color: var(--success); border: 1px solid rgba(0, 193, 118, 0.3);">
                            <i class="fas fa-play mr-1"></i> Start
                        </button>
                        `}
                        <button class="configure-bot-btn px-3 py-2 rounded-lg text-sm transition-colors" style="background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color);">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="details-bot-btn px-3 py-2 rounded-lg text-sm transition-colors" style="background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color);">
                            <i class="fas fa-chart-line"></i>
                        </button>
                        ` : botStatus === 'paused' ? `
                        <button class="run-bot-btn flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors" style="background: rgba(255, 69, 0, 0.2); color: var(--accent-primary); border: 1px solid rgba(255, 69, 0, 0.3);">
                            <i class="fas fa-play mr-1"></i> Resume
                        </button>
                        <button class="configure-bot-btn px-3 py-2 rounded-lg text-sm transition-colors" style="background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color);">
                            <i class="fas fa-cog"></i>
                        </button>
                        ` : `
                        <button class="renew-bot-btn flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors" style="background: rgba(255, 69, 0, 0.2); color: var(--accent-primary); border: 1px solid rgba(255, 69, 0, 0.3);">
                            <i class="fas fa-sync-alt mr-1"></i> Renew
                        </button>
                        `}
                    </div>
                </div>
            `;

            return card;
        }

        // Attach event listeners to bot cards
        function attachBotCardListeners() {
            const loadingSpinner = document.getElementById('loadingSpinner');

            // Run/Stop buttons
            document.querySelectorAll('.run-bot-btn, .stop-bot-btn').forEach(button => {
                button.addEventListener('click', async function () {
                    const card = this.closest('[data-bot-id]');
                    const botId = card.dataset.botId;
                    const isRunning = this.classList.contains('stop-bot-btn');

                    loadingSpinner.classList.remove('hidden');
                    const originalText = this.innerHTML;
                    this.innerHTML = '<i class="fas fa-circle-notch animate-spin mr-1"></i>';
                    this.disabled = true;

                    try {
                        // Call API to start/stop bot
                        const response = await authFetch(`/api/bots/${botId}/${isRunning ? 'stop' : 'start'}`, {
                            method: 'POST'
                        });

                        showNotification(`${isRunning ? 'Stopped' : 'Started'} bot successfully!`, 'success');

                        // Reload bots to update status
                        setTimeout(() => {
                            loadUserBots();
                        }, 1000);

                    } catch (error) {
                        console.error('Failed to control bot:', error);
                        showNotification(`Error: ${error.message}`, 'error');
                    } finally {
                        setTimeout(() => {
                            loadingSpinner.classList.add('hidden');
                            this.innerHTML = originalText;
                            this.disabled = false;
                        }, 1000);
                    }
                });
            });

            // Configure buttons
            document.querySelectorAll('.configure-bot-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const card = this.closest('[data-bot-id]');
                    const botId = card.dataset.botId;
                    showNotification('Configuration page coming soon!', 'info');
                    // window.location.href = `/bots/${botId}/configure`;
                });
            });

            // Renew buttons
            document.querySelectorAll('.renew-bot-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const card = this.closest('[data-bot-id]');
                    const botId = card.dataset.botId;
                    showNotification('Renewal page coming soon!', 'info');
                    // window.location.href = `/payment/renew/${botId}`;
                });
            });

            // Details buttons
            document.querySelectorAll('.details-bot-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const card = this.closest('[data-bot-id]');
                    const botId = card.dataset.botId;
                    showNotification('Statistics page coming soon!', 'info');
                    // window.location.href = `/bots/${botId}/stats`;
                });
            });

            // View buttons
            document.querySelectorAll('.view-bot-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const card = this.closest('[data-bot-id]');
                    const botId = card.dataset.botId;
                    window.location.href = `/bots/${botId}`;
                });
            });
        }

        // Filter bots
        function filterBots(filter) {
            const botsGrid = document.getElementById('botsGrid');
            const cards = botsGrid.querySelectorAll('[data-status]');

            cards.forEach(card => {
                const status = card.getAttribute('data-status');
                const purchaseType = card.getAttribute('data-purchase-type');

                let shouldShow = false;

                switch (filter) {
                    case 'all':
                        shouldShow = true;
                        break;
                    case 'active':
                        shouldShow = status === 'active';
                        break;
                    case 'paused':
                        shouldShow = status === 'paused';
                        break;
                    case 'rental':
                        shouldShow = purchaseType === 'rental';
                        break;
                    case 'purchased':
                        shouldShow = purchaseType === 'purchased';
                        break;
                    default:
                        shouldShow = true;
                }

                card.style.display = shouldShow ? 'block' : 'none';
            });
        }

        // Sort bots
        function sortBots(criteria) {
            const botsGrid = document.getElementById('botsGrid');
            const cards = Array.from(botsGrid.querySelectorAll('[data-bot-id]'));

            cards.sort((a, b) => {
                switch (criteria) {
                    case 'name':
                        const aName = a.querySelector('h3').textContent;
                        const bName = b.querySelector('h3').textContent;
                        return aName.localeCompare(bName);
                    case 'performance':
                        const aPerf = parseFloat(a.querySelector('.font-semibold').textContent) || 0;
                        const bPerf = parseFloat(b.querySelector('.font-semibold').textContent) || 0;
                        return bPerf - aPerf;
                    case 'cost':
                        const aCost = parseFloat(a.querySelector('.text-white.font-semibold').textContent.replace('$', '')) || 0;
                        const bCost = parseFloat(b.querySelector('.text-white.font-semibold').textContent.replace('$', '')) || 0;
                        return bCost - aCost;
                    case 'recent':
                    default:
                        return 0; // Already in order
                }
            });

            // Re-append cards in sorted order
            cards.forEach(card => botsGrid.appendChild(card));
        }

        // Show notification
        function showNotification(message, type = 'info') {
            // Remove any existing notification
            const existingNotification = document.getElementById('global-notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.id = 'global-notification';
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300 ${type === 'success' ? 'bg-green-500 text-white' :
                    type === 'error' ? 'bg-red-500 text-white' :
                        type === 'info' ? 'bg-blue-500 text-white' :
                            type === 'warning' ? 'bg-yellow-500 text-white' :
                                'bg-primary-500 text-white'
                }`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} mr-3"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Update filter button styles
        function setupEventListeners() {
            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(button => {
                button.addEventListener('click', function () {
                    // Update active button
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');

                    // Filter bots
                    const filter = this.getAttribute('data-filter');
                    filterBots(filter);
                });
            });

            // Sort dropdown
            const sortSelect = document.getElementById('sortSelect');
            if (sortSelect) {
                sortSelect.addEventListener('change', function () {
                    sortBots(this.value);
                });
            }

            // Search functionality
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function () {
                    const searchTerm = this.value.toLowerCase();
                    const cards = document.querySelectorAll('[data-bot-id]');

                    cards.forEach(card => {
                        const botName = card.querySelector('h3').textContent.toLowerCase();
                        const creatorName = card.querySelector('.text-white\\/80').textContent.toLowerCase();

                        if (botName.includes(searchTerm) || creatorName.includes(searchTerm)) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function () {
            // Load user profile
            loadUserProfile();

            // Set up event listeners
            setupEventListeners();

            // Load user's bots
            loadUserBots();
        });
    </script>
</body>

</html>