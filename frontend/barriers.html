<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Highs & Lows Trading | Algocdk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: #0D1421;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .panel {
            background: #0A0E1A;
            border: 1px solid #1E293B;
            border-radius: 8px;
        }
        .btn-primary { background: #FF4500; }
        .btn-primary:hover { background: #e63e00; }
        .btn-success { background: #00C851; }
        .btn-success:hover { background: #00a844; }
        .btn-danger { background: #FF4444; }
        .btn-danger:hover { background: #e63939; }
        .input-field {
            background: #1E293B;
            border: 1px solid #334155;
            color: #ffffff;
            border-radius: 6px;
            padding: 12px;
        }
        .input-field:focus {
            outline: none;
            border-color: #FF4500;
            box-shadow: 0 0 0 3px rgba(255, 69, 0, 0.1);
        }
        .trade-btn {
            padding: 16px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
            color: white;
        }
        .chart-container {
            background: #0A0E1A;
            border-radius: 8px;
            padding: 20px;
            height: 400px;
        }
        .barrier-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #FF4500;
            z-index: 10;
        }
        @media (max-width: 768px) {
            .grid-cols-2 { grid-template-columns: 1fr; }
            .lg\\:grid-cols-3 { grid-template-columns: 1fr; }
            .chart-container { height: 300px; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="bg-[#0A0E1A] border-b border-gray-700 px-4 py-3 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-[#FF4500] rounded flex items-center justify-center">
                        <span class="text-white font-bold text-sm">A</span>
                    </div>
                    <span class="text-xl font-bold">Algocdk</span>
                </div>
                <nav class="hidden md:flex space-x-6">
                    <a href="/app" class="text-gray-400 hover:text-white">Chart</a>
                    <a href="/trading" class="text-[#FF4500] font-semibold">Trade</a>
                    <a href="/mybots" class="text-gray-400 hover:text-white">Bots</a>
                </nav>
            </div>
            
            <div class="flex items-center space-x-4">
                <button onclick="toggleAccountType()" class="px-3 py-1 text-sm rounded-lg font-semibold transition-all" id="accountTypeBtn">
                    Demo
                </button>
                <div class="text-right">
                    <div class="text-xs text-gray-400" id="balanceLabel">Demo Balance</div>
                    <div class="font-bold text-lg" id="accountBalance">10,000.00 USD</div>
                </div>
                <button onclick="exitApp()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        <div class="mb-6">
            <div class="flex items-center space-x-4">
                <button onclick="window.location.href='/trading'" class="text-gray-400 hover:text-white">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Trading
                </button>
                <h1 class="text-2xl font-bold">Highs & Lows Trading</h1>
            </div>
        </div>

        <div class="grid lg:grid-cols-3 gap-6">
            <!-- Chart Panel -->
            <div class="lg:col-span-2">
                <div class="panel p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold">Price Chart with Barriers</h3>
                        <select id="marketSelect" class="input-field text-sm">
                            <option value="R_10">Volatility 10 Index</option>
                            <option value="R_25">Volatility 25 Index</option>
                            <option value="R_50">Volatility 50 Index</option>
                            <option value="R_75">Volatility 75 Index</option>
                            <option value="R_100" selected>Volatility 100 Index</option>
                        </select>
                    </div>
                    <div class="chart-container relative">
                        <canvas id="chart"></canvas>
                    </div>
                </div>

                <!-- Barrier Info -->
                <div class="panel p-6">
                    <h3 class="text-lg font-bold mb-4">Barrier Information</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-[#FF4500]" id="currentPrice">1234.567</div>
                            <div class="text-sm text-gray-400">Current Price</div>
                        </div>
                        <div class="text-center">
                            <div class="text-lg font-bold text-orange-500" id="barrierPrice">1235.000</div>
                            <div class="text-sm text-gray-400">Barrier</div>
                        </div>
                        <div class="text-center">
                            <div class="text-lg font-bold" id="distanceToBarrier">+0.433</div>
                            <div class="text-sm text-gray-400">Distance</div>
                        </div>
                        <div class="text-center">
                            <div class="text-lg font-bold" id="touchStatus">No Touch</div>
                            <div class="text-sm text-gray-400">Status</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trading Panel -->
            <div class="lg:col-span-1">
                <div class="panel p-6 mb-6">
                    <h3 class="text-lg font-bold mb-4">Trade Parameters</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Trade Type</label>
                            <select id="tradeType" class="input-field w-full" onchange="updateTradeType()">
                                <option value="ONETOUCH">Touch/No Touch</option>
                                <option value="EXPIRYRANGE">Ends Between/Outside</option>
                                <option value="RANGE">Stays Between/Goes Outside</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Stake (USD)</label>
                            <input type="number" id="stakeAmount" value="1" min="0.35" step="0.01" 
                                   class="input-field w-full" onchange="updatePayout()">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Duration</label>
                            <div class="flex space-x-2">
                                <input type="number" id="duration" value="5" min="1" class="input-field flex-1">
                                <select id="durationUnit" class="input-field" onchange="updatePayout()">
                                    <option value="t">Ticks</option>
                                    <option value="s">Seconds</option>
                                    <option value="m">Minutes</option>
                                </select>
                            </div>
                        </div>

                        <div id="barrierSection">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Barrier</label>
                            <input type="number" id="barrier" step="0.001" class="input-field w-full" 
                                   onchange="updateBarrier()">
                        </div>

                        <div id="barrier2Section" style="display: none;">
                            <label class="block text-sm font-medium text-gray-300 mb-2">High Barrier</label>
                            <input type="number" id="barrier2" step="0.001" class="input-field w-full" 
                                   onchange="updateBarrier()">
                            <label class="block text-sm font-medium text-gray-300 mb-2 mt-2">Low Barrier</label>
                            <input type="number" id="barrierLow" step="0.001" class="input-field w-full" 
                                   onchange="updateBarrier()">
                        </div>
                    </div>
                </div>

                <!-- Purchase Buttons -->
                <div class="panel p-6 mb-6">
                    <h3 class="text-lg font-bold mb-4">Purchase</h3>
                    <div class="space-y-3" id="purchaseButtons">
                        <button class="trade-btn btn-primary w-full" onclick="placeTrade('ONETOUCH')">
                            <div class="flex justify-between items-center">
                                <span>Touch</span>
                                <span id="touchPayout">2.50</span>
                            </div>
                        </button>
                        <button class="trade-btn bg-gray-600 w-full" onclick="placeTrade('NOTOUCH')">
                            <div class="flex justify-between items-center">
                                <span>No Touch</span>
                                <span id="notouchPayout">1.40</span>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Trade Summary -->
                <div class="panel p-6">
                    <h3 class="text-lg font-bold mb-4">Trade Summary</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Potential Payout:</span>
                            <span class="font-bold text-green-500" id="potentialPayout">2.50 USD</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Potential Profit:</span>
                            <span class="font-bold text-green-500" id="potentialProfit">1.50 USD</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Commission:</span>
                            <span class="font-bold">0.00 USD</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let widget = null;
        let currentPrice = 1234.567;
        let isDemo = true;
        let barrierValue = 1235.000;
        let barrierTouched = false;

        document.addEventListener('DOMContentLoaded', function() {
            initializeAccount();
            initializeTradingView();
            connectWebSocket();
            updateBarrier();
            updatePayout();
        });

        function initializeAccount() {
            const savedAccountType = localStorage.getItem('accountType');
            if (savedAccountType === 'real') {
                isDemo = false;
            }
            updateAccountDisplay();
        }

        function initializeTradingView() {
            widget = new TradingView.widget({
                "width": "100%",
                "height": 400,
                "symbol": "OANDA:SPX500USD",
                "interval": "1",
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "1",
                "locale": "en",
                "toolbar_bg": "#0A0E1A",
                "enable_publishing": false,
                "hide_top_toolbar": false,
                "hide_legend": true,
                "save_image": false,
                "container_id": "tradingview_chart",
                "backgroundColor": "#0A0E1A",
                "gridColor": "#1E293B",
                "hide_side_toolbar": false,
                "allow_symbol_change": false,
                "studies": [],
                "overrides": {
                    "paneProperties.background": "#0A0E1A",
                    "paneProperties.vertGridProperties.color": "#1E293B",
                    "paneProperties.horzGridProperties.color": "#1E293B",
                    "symbolWatermarkProperties.transparency": 90,
                    "scalesProperties.textColor": "#94a3b8"
                }
            });
        }

        function connectWebSocket() {
            ws = new WebSocket("wss://ws.derivws.com/websockets/v3?app_id=1089");
            
            ws.onopen = () => {
                const market = document.getElementById('marketSelect').value;
                ws.send(JSON.stringify({ ticks: market, subscribe: 1 }));
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.tick) {
                    updatePrice(parseFloat(data.tick.quote));
                }
            };
            
            ws.onclose = () => {
                setTimeout(connectWebSocket, 3000);
            };
        }

        function updatePrice(price) {
            currentPrice = price;
            
            // Check barrier touch
            if (!barrierTouched && Math.abs(price - barrierValue) < 0.001) {
                barrierTouched = true;
            }
            
            // Update display
            document.getElementById('currentPrice').textContent = price.toFixed(3);
            document.getElementById('barrierPrice').textContent = barrierValue.toFixed(3);
            
            const distance = price - barrierValue;
            const distanceEl = document.getElementById('distanceToBarrier');
            distanceEl.textContent = (distance >= 0 ? '+' : '') + distance.toFixed(3);
            distanceEl.className = `text-lg font-bold ${distance >= 0 ? 'text-green-500' : 'text-red-500'}`;
            
            const statusEl = document.getElementById('touchStatus');
            statusEl.textContent = barrierTouched ? 'Touched' : 'No Touch';
            statusEl.className = `text-lg font-bold ${barrierTouched ? 'text-green-500' : 'text-gray-400'}`;
            
            updatePayout();
        }

        function updateTradeType() {
            const tradeType = document.getElementById('tradeType').value;
            const barrier2Section = document.getElementById('barrier2Section');
            const barrierSection = document.getElementById('barrierSection');
            const purchaseButtons = document.getElementById('purchaseButtons');
            
            if (tradeType === 'EXPIRYRANGE' || tradeType === 'RANGE') {
                barrierSection.style.display = 'none';
                barrier2Section.style.display = 'block';
                document.getElementById('barrier2').value = (currentPrice + 0.5).toFixed(3);
                document.getElementById('barrierLow').value = (currentPrice - 0.5).toFixed(3);
                
                if (tradeType === 'EXPIRYRANGE') {
                    purchaseButtons.innerHTML = `
                        <button class="trade-btn btn-success w-full" onclick="placeTrade('EXPIRYMISS')">
                            <div class="flex justify-between items-center">
                                <span>Ends Between</span>
                                <span id="betweenPayout">3.20</span>
                            </div>
                        </button>
                        <button class="trade-btn btn-danger w-full" onclick="placeTrade('EXPIRYRANGE')">
                            <div class="flex justify-between items-center">
                                <span>Ends Outside</span>
                                <span id="outsidePayout">1.31</span>
                            </div>
                        </button>
                    `;
                } else {
                    purchaseButtons.innerHTML = `
                        <button class="trade-btn btn-success w-full" onclick="placeTrade('RANGE')">
                            <div class="flex justify-between items-center">
                                <span>Stays Between</span>
                                <span id="staysPayout">2.80</span>
                            </div>
                        </button>
                        <button class="trade-btn btn-danger w-full" onclick="placeTrade('UPORDOWN')">
                            <div class="flex justify-between items-center">
                                <span>Goes Outside</span>
                                <span id="goesPayout">1.36</span>
                            </div>
                        </button>
                    `;
                }
            } else {
                barrierSection.style.display = 'block';
                barrier2Section.style.display = 'none';
                purchaseButtons.innerHTML = `
                    <button class="trade-btn btn-primary w-full" onclick="placeTrade('ONETOUCH')">
                        <div class="flex justify-between items-center">
                            <span>Touch</span>
                            <span id="touchPayout">2.50</span>
                        </div>
                    </button>
                    <button class="trade-btn bg-gray-600 w-full" onclick="placeTrade('NOTOUCH')">
                        <div class="flex justify-between items-center">
                            <span>No Touch</span>
                            <span id="notouchPayout">1.40</span>
                        </div>
                    </button>
                `;
            }
            updateBarrier();
            updatePayout();
        }

        function updateBarrier() {
            const tradeType = document.getElementById('tradeType').value;
            
            if (tradeType === 'ONETOUCH') {
                barrierValue = parseFloat(document.getElementById('barrier').value) || (currentPrice + 0.1);
                document.getElementById('barrier').value = barrierValue.toFixed(3);
            }
            
            barrierTouched = false;
            updatePayout();
        }

        function updatePayout() {
            const stake = parseFloat(document.getElementById('stakeAmount').value) || 1;
            const multiplier = 2.50;
            const payout = stake * multiplier;
            const profit = payout - stake;
            
            document.getElementById('potentialPayout').textContent = `${payout.toFixed(2)} USD`;
            document.getElementById('potentialProfit').textContent = `${profit.toFixed(2)} USD`;
            
            // Update button payouts based on trade type
            const tradeType = document.getElementById('tradeType').value;
            if (tradeType === 'ONETOUCH') {
                const touchEl = document.getElementById('touchPayout');
                const notouchEl = document.getElementById('notouchPayout');
                if (touchEl) touchEl.textContent = (stake * 2.50).toFixed(2);
                if (notouchEl) notouchEl.textContent = (stake * 1.40).toFixed(2);
            }
        }

        function placeTrade(contractType) {
            const stake = parseFloat(document.getElementById('stakeAmount').value) || 1;
            const duration = parseInt(document.getElementById('duration').value) || 5;
            const durationUnit = document.getElementById('durationUnit').value;
            const market = document.getElementById('marketSelect').value;
            
            let proposal = {
                proposal: 1,
                amount: stake,
                contract_type: contractType,
                currency: "USD",
                symbol: market,
                basis: "stake"
            };
            
            // Add duration
            if (durationUnit === 't') {
                proposal.duration = duration;
                proposal.duration_unit = 't';
            } else if (durationUnit === 's') {
                proposal.duration = duration;
                proposal.duration_unit = 's';
            } else {
                proposal.duration = duration;
                proposal.duration_unit = 'm';
            }
            
            // Add barriers
            const tradeType = document.getElementById('tradeType').value;
            if (tradeType === 'ONETOUCH') {
                proposal.barrier = document.getElementById('barrier').value;
            } else if (tradeType === 'EXPIRYRANGE' || tradeType === 'RANGE') {
                proposal.barrier = document.getElementById('barrier2').value;
                proposal.barrier2 = document.getElementById('barrierLow').value;
            }
            
            // Send proposal to get price
            ws.send(JSON.stringify(proposal));
            
            // Listen for proposal response
            const originalOnMessage = ws.onmessage;
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.proposal) {
                    // Buy the contract
                    const buyRequest = {
                        buy: data.proposal.id,
                        price: data.proposal.ask_price
                    };
                    ws.send(JSON.stringify(buyRequest));
                    
                    // Show success message
                    const tradeNames = {
                        'ONETOUCH': 'Touch',
                        'NOTOUCH': 'No Touch',
                        'EXPIRYRANGE': 'Ends Outside',
                        'EXPIRYMISS': 'Ends Between',
                        'RANGE': 'Stays Between',
                        'UPORDOWN': 'Goes Outside'
                    };
                    
                    alert(`${tradeNames[contractType]} trade placed for ${stake} USD`);
                    
                    // Update balance
                    updateBalance(-stake);
                    
                    // Restore original message handler
                    ws.onmessage = originalOnMessage;
                } else if (data.buy) {
                    console.log('Trade executed:', data.buy);
                } else {
                    originalOnMessage(event);
                }
            };
        }

        function updateBalance(change) {
            const currentBalance = parseFloat(document.getElementById('accountBalance').textContent.replace(/[^0-9.]/g, ''));
            const newBalance = currentBalance + change;
            document.getElementById('accountBalance').textContent = `${newBalance.toFixed(2)} USD`;
            
            if (isDemo) {
                localStorage.setItem('demoBalance', newBalance.toFixed(2));
            } else {
                localStorage.setItem('realBalance', newBalance.toFixed(2));
            }
        }

        function toggleAccountType() {
            isDemo = !isDemo;
            localStorage.setItem('accountType', isDemo ? 'demo' : 'real');
            updateAccountDisplay();
        }

        function updateAccountDisplay() {
            const btn = document.getElementById('accountTypeBtn');
            const label = document.getElementById('balanceLabel');
            const balance = document.getElementById('accountBalance');
            
            const demoBalance = localStorage.getItem('demoBalance') || '10000.00';
            const realBalance = localStorage.getItem('realBalance') || '0.00';
            
            if (isDemo) {
                btn.textContent = 'Demo';
                btn.className = 'px-3 py-1 text-sm rounded-lg font-semibold transition-all bg-green-600 text-white';
                label.textContent = 'Demo Balance';
                balance.textContent = `${parseFloat(demoBalance).toFixed(2)} USD`;
                balance.className = 'font-bold text-lg text-green-500';
            } else {
                btn.textContent = 'Real';
                btn.className = 'px-3 py-1 text-sm rounded-lg font-semibold transition-all bg-red-600 text-white';
                label.textContent = 'Real Balance';
                balance.textContent = `${parseFloat(realBalance).toFixed(2)} USD`;
                balance.className = 'font-bold text-lg text-red-500';
            }
        }

        function exitApp() {
            if (ws) ws.close();
            localStorage.removeItem('authToken');
            localStorage.removeItem('userSession');
            window.location.href = '/auth';
        }

        // Market change handler
        document.getElementById('marketSelect').addEventListener('change', function() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ forget_all: 'ticks' }));
                ws.send(JSON.stringify({ ticks: this.value, subscribe: 1 }));
            }
            
            // Reset price tracking
            priceData = [];
            barrierTouched = false;
            updateBarrier();
        });
    </script>
</body>
</html>