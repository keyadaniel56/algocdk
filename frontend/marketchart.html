<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Chart - AlgoCDK</title>

    <!-- CSS -->
    <link href="css/theme-enhanced.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Chart container */
        #chart-container {
            position: relative;
            width: 100%;
            height: calc(100vh - 64px);
            /* Adjust for navbar height */
            background-color: var(--bg-tertiary);
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        /* Controls Overlay */
        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            background-color: var(--bg-secondary);
            backdrop-filter: blur(10px);
            padding: 8px;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            box-shadow: var(--shadow-sm);
        }

        select {
            background-color: var(--bg-accent);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 6px 12px;
            border-radius: 0.375rem;
            font-size: 14px;
            outline: none;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        select:hover {
            border-color: var(--primary);
        }

        /* Indicator Tags */
        #activeIndicators {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .indicator-tag {
            background-color: var(--bg-accent);
            color: var(--text-secondary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .indicator-tag:hover {
            color: var(--danger);
            border-color: var(--danger);
            background-color: rgba(255, 68, 68, 0.1);
        }

        .indicator-tag::after {
            content: '\f00d';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
        }

        /* Price Display */
        .price-display {
            position: absolute;
            top: 20px;
            right: 20px;
            /* Center on mobile */
            left: auto;
            transform: none;
            z-index: 10;
            background-color: var(--bg-secondary);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 0.375rem;
            border: 1px solid var(--border-color);
            text-align: center;
            box-shadow: var(--shadow-sm);
        }

        .current-price {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 2px;
            font-family: 'Courier New', monospace;
        }

        .price-change {
            font-size: 12px;
            font-weight: 500;
        }

        .price-up {
            color: var(--success);
        }

        .price-down {
            color: var(--danger);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            #controls {
                flex-wrap: wrap;
                max-width: calc(100vw - 20px);
                font-size: 14px;
                padding: 12px;
                gap: 12px;
            }

            select {
                padding: 8px 12px;
                font-size: 14px;
                min-height: 44px;
                min-width: 80px;
            }

            .price-display {
                top: auto;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                width: auto;
                min-width: 200px;
            }
        }
    </style>
</head>

<body>

    <!-- Standard Navigation -->
    <div id="nav-container"></div>
    <!-- Scripts -->
    <script src="api.js"></script>
    <script src="components.js"></script>
    <script>
        document.getElementById('nav-container').innerHTML = Components.renderNav('chart');
        Components.init();
    </script>

    <div id="chart-container">
        <!-- Price Display -->
        <div class="price-display">
            <div class="current-price" id="currentPrice">--</div>
            <div class="price-change" id="priceChange">--</div>
        </div>

        <!-- Controls -->
        <div id="controls">
            <select id="symbol">
                <option value="R_50">Vol 50</option>
                <option value="R_75">Vol 75</option>
                <option value="R_100" selected>Vol 100</option>
                <option value="frxEURUSD">EUR/USD</option>
                <option value="cryBTCUSD">BTC/USD</option>
            </select>

            <select id="timeframe">
                <option value="10">10s</option>
                <option value="30">30s</option>
                <option value="60" selected>1m</option>
                <option value="300">5m</option>
            </select>

            <select id="indicators">
                <option value="">Add Indicator</option>
                <option value="sma20">SMA 20</option>
                <option value="sma50">SMA 50</option>
                <option value="ema20">EMA 20</option>
                <option value="bb">Bollinger Bands</option>
                <option value="rsi">RSI</option>
            </select>

            <div id="activeIndicators"></div>
        </div>

        <canvas id="chart"></canvas>
    </div>

    <!-- Chart Engine -->
    <script src="chart-engine.js"></script>
    <script>
        // Initialize Chart
        const chart = new TradingChart({
            containerId: 'chart-container',
            canvasId: 'chart',
            symbol: 'R_100',
            timeframe: 60,
            onPriceUpdate: updatePriceDisplay
        });

        /* ================= CONTROLS ================= */
        document.getElementById("symbol").onchange = e => {
            chart.setSymbol(e.target.value);
        };

        document.getElementById("timeframe").onchange = e => {
            chart.setTimeframe(+e.target.value);
        };

        document.getElementById("indicators").onchange = e => {
            if (e.target.value) {
                chart.addIndicator(e.target.value);
                updateIndicatorTags();
                e.target.value = "";
            }
        };

        function updateIndicatorTags() {
            const container = document.getElementById("activeIndicators");
            container.innerHTML = "";
            chart.indicators.forEach((ind, type) => {
                const tag = document.createElement("span");
                tag.className = "indicator-tag";
                tag.textContent = getIndicatorName(type);
                tag.onclick = () => {
                    chart.removeIndicator(type);
                    updateIndicatorTags();
                };
                container.appendChild(tag);
            });
        }

        function getIndicatorName(type) {
            const names = {
                sma20: "SMA 20", sma50: "SMA 50", ema20: "EMA 20",
                bb: "BB", rsi: "RSI"
            };
            return names[type] || type;
        }

        /* ================= PRICE DISPLAY ================= */
        let previousPrice = null;

        function updatePriceDisplay(currentPrice) {
            const priceEl = document.getElementById('currentPrice');
            const changeEl = document.getElementById('priceChange');

            // Use internal previous price logic or fetch from chart history?
            // Chart engine passes current price.
            // We can infer change from chart.candles if needed, 
            // but keeping a local previousPrice is simpler for tick updates
            // better: look at the previous candle close from chart data

            // To be accurate with the previous logic:
            // "previousPrice = candles[candles.length - 1]?.close || currentPrice;"
            // But we don't have direct access to candles here unless we expose them or pass them.
            // Chart engine exposes chart.candles.

            if (chart.candles.length > 0) {
                // The last candle in array is the *previous* completed candle? 
                // chart.candles array usually contains history. 
                // If currentCandle is active, chart.candles has closed candles.
                // So previous close is chart.candles[last].close

                const prev = chart.candles[chart.candles.length - 1]?.close || currentPrice;
                const change = currentPrice - prev;
                const changePercent = ((change / prev) * 100).toFixed(2);

                priceEl.textContent = currentPrice.toFixed(5);
                changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(5)} (${change >= 0 ? '+' : ''}${changePercent}%)`;
                changeEl.className = `price-change ${change >= 0 ? 'price-up' : 'price-down'}`;
            } else {
                priceEl.textContent = currentPrice.toFixed(5);
                changeEl.textContent = '--';
            }
        }
    </script>

</body>

</html>